# V10 方法论工程验收标准（审查者版本）

> 目的：把“测量复杂系统的方法”从哲学叙事，落到**可复现、可审计、可证伪**的工程验收协议。  
> 立场：不预设“涌现应当长成什么样”。只裁决：系统是否确实利用了市场时间结构，并且结论在对照/消融下成立。

---

## 0. 总目标（裁决口径：以量化交易为实例的工程审查）

**方法有效** ≈ 在严格的可复现与可审计前提下：

- 在**真实时间结构**数据（A组）上，持续出现“利用时间结构”的证据；
- 在**零假设对照**（B组，破坏时间结构但保持单步波动分布）上，该证据显著变弱或消失；
- 在**消融/扰动**（C组）下，该证据按预期退化；
- 全流程不存在“口径错误/数值爆炸/账本不闭合”这类工程幻觉。

> 说明：我们用“量化交易”作为实例来检验演化方法论，因此裁判尺度必须来自交易世界的硬约束（净值、回撤、摩擦、强平、可持续性、可对账）。  
> 这里的“有效”不是“证明真理”，而是获得工程意义上的可信度增量。

---

## 1. Gate 0：工程与会计完整性（硬门槛）

任一项失败，直接判定本轮实验**无效**（先修尺子，再谈结论）。

- **G0.1 可复现**
  - 同一 commit + 同一 config + 同一 seed + 同一数据窗口 → 关键统计一致（允许浮点微差，但需在阈值内）。

- **G0.2 可审计（落盘，不只终端）**
  - 每次运行输出的 JSON/报告中必须包含：
    - 配置（阈值、agent数、ticks、seed列表、数据文件与时间窗）
    - 资金三元组：`allocated_capital / system_reserve / current_total`
    - 下葬与崩溃事件（时间戳/计数/原因）
    - 审计声明（mode、资金模型语义、下葬契约版本等）

- **G0.3 数值健康**
  - 不允许出现 `NaN/Inf/溢出`。出现即判该 run 作废，并必须定位原因。
  - **对照组构造不物理**导致溢出，也属于失败（对照无效）。

- **G0.4 统计口径正确**
  - 盈利/ROI等统计必须同时覆盖：
    - **全体（含死亡）**：例如 `profitable_agents_all`
    - **存活子集**：例如 `profitable_agents_alive`
  - 禁止混淆（例如把 `alive` 当分母导致“存活=盈利”的假象）。

- **G0.5 对照组物理合理**
  - 零假设必须破坏时间结构，但不能引入“现实中不可能的巨大跳变频率”。

- **G0.6 禁止“隐含预设策略”（Prior leakage audit）**
  - 目的：避免“尺子里塞了策略”，把后续所有 A/B 裁决污染掉。
  - 最低要求（任一失败 → 本轮实验无效）：
    - **特征侧**：不得直接硬编码典型交易指标/策略公式（如 RSI/MACD/均线交叉/专用微结构识别器）。允许“原始观测”与“物理可解释的变换”（归一化、tanh压缩、EMA平滑）——但必须在文档中声明。
    - **表达/执行侧**：不得用硬阈值把某种交易风格写死（除“生态/物理规则”外）；若存在硬阈值，必须列出清单并在 Gate 3 做消融验证。
    - **死基因/冗余维度**：如果基因包含不再生效的维度（例如阈值被路线升级后废弃），必须显式标注，否则“基因维度最小化”判定失败。

- **G0.7 Core 变更触发“裁决失效”与回归门槛（强制）**
  - 目的：确保“裁决”对应同一个世界版本；避免改了世界规则却沿用旧结论。
  - 适用范围：任何 `prometheus/v10/core/` 的变更（包括特征、决策、资金/清算、生命周期、数值处理等）。
  - 强制规则：
    - 一旦 core 发生变更：此前所有裁决记录视为**不再可直接引用**，必须重做**最小回归裁决**。
    - **最小回归集合**（建议工程线）：至少重跑 Gate 1（A vs B2）；若变更触及窗口/稳健性或归因链，则必须相应重跑 Gate 2/3（窗口迁移、消融、v2/v3审计）。
  - 审计要求（必须落盘）：
    - 每次运行必须在 `run_manifest/summary.meta` 写入：`git_commit`（世界版本）+ `config_hash` + `python_version` + `docker_image_digest`（若适用）。

---

## 2. Gate 1：非随机性（必须有对照）

**核心问题**：系统的表现差异是否来自“时间结构”，而不是噪声/偶然。

### 2.1 实验组与对照组（最低配置）

- **A组（真实时间结构）**：真实历史数据原序列。
- **B组（零假设）**：破坏时间顺序，但保持单步波动分布近似真实。
  - 推荐：**打乱收益率（return/log-return）序列后重建价格**，而不是直接随机置换价格。

> 若B组跑不通或数值爆炸：对照无效，Gate 1 不能裁决。

### 2.2 主指标（Primary endpoints，已锁定）

为避免“挑好看的指标”，必须**预先固定**主指标（建议选2个，最多3个）。本项目现阶段锁定为2个：

- **Primary #1：`system_roi`（基于`current_total`）**
  - 定义：`system_roi = current_total / initial_total_capital - 1`
  - 口径：`current_total = allocated_capital + system_reserve`
- **Primary #2：`extinction_rate`（灭绝比例）**
  - 定义：`alive_agents == 0` 的 run 占比

> 说明：`profitable_agents_all` 对结构更敏感，但容易被“刷微利/阈值抖动”误导，因此降级为次指标（Secondary）。

### 2.2.1 次指标（Secondary endpoints，建议保留但不作为通过/失败唯一依据）

- **`profitable_agents_all`**：全体盈利人数/比例（含死亡）
- **回撤类**：`max_drawdown`（至少给分位数或置信区间）
- **换手/交易摩擦代理**：`total_trades`、（如可得）`avg_M7 / avg_M9`
- **存活结构**：`avg_alive_agents`、`avg_total_agents`（总谱系规模）

### 2.3 统计判定（建议）

对每个主指标，比较 A vs B：

- 连续指标（如`system_roi`、盈利人数）：推荐 **Mann–Whitney U**（非参数，稳健）。
- 比例指标（如灭绝率）：推荐 **费舍尔精确检验**或比例检验。

**通过条件**（工程审查线，非真理）：

- 统计显著：`p < 0.05`（多指标需多重校正或只对主指标检验）
- 同时具备**最小效应量**（例如 `system_roi` 差异 ≥ 2pp；或盈利人数差异 ≥ 50%）

---

## 3. Gate 2：稳健性（可重复、可迁移、不靠偶然）

- **G2.1 seed规模**
  - 建议 `n_seeds >= 30`（至少30；更强建议50/100用于稳定性评估）。

- **G2.2 稳定性呈现**
  - 不只给均值：必须给中位数/分位数/置信区间，避免被极端值带偏。

- **G2.3 时间窗迁移**
  - 至少两个不重叠窗口（或两种市场状态窗口）中，A>B结论方向一致。

- **G2.4 避免信息泄漏**
  - 禁止使用未来信息（包括归一化、滚动窗口实现错误等）。

- **G2.5 赢家口径固定（B阶段v2硬化）**
  - 目的：避免“各组各自挑分位数”导致口径漂移，让“赢家/尾部”可比较、可复核。
  - 最低要求（必须同时做两套赢家阈值）：
    - **绝对阈值**：`roi_lifetime >= +5%`（可替换为+2%/+10%，但必须预先声明并固定）
    - **锚定阈值（A锚定）**：用 A 组阈值（优先 `q90_A`）作为同一把尺子，应用到 A 与 B（同一阈值）
  - **退化处理（强制）**：若 `q90_A <= 0`，不得用 `roi>=q90_A`（退化为近似 `roi>=0`）
    - 优先改用：`q95_A`
    - 次选：`q90_A_pos`（在 `roi_lifetime>0` 子集中取0.9分位数；样本数≥50）
    - 兜底：绝对阈值 `+5%`
  - 输出要求：
    - `q90_A`、最终 anchor 方法与阈值数值（method/value）
    - `winner_rate_abs` 与 `winner_rate_anchor`（A/B）
  - 参考协议：`docs/v10/V10_B_STAGE_V2_PROTOCOL_WINNER_DEFINITION_AND_SIGN_CONSISTENCY.md`

---

## 4. Gate 3：因果归因（消融/扰动）

**目的**：证明你测到的差异来自你声称的观测通道，而不是隐藏漏洞。

- **G3.1 观测通道消融（ablation）**
  - 例：将某一类输入置空（如 `M={}` 或 `C={}`）。
  - 预期：A>B 的主指标差异应显著减弱或消失。

- **G3.2 小扰动敏感性**
  - 对关键阈值做小范围扰动（例如 ±20%），结论不应完全翻盘。

- **G3.3 Prior leakage 消融（强制）**
  - 目的：证明你看到的差异不是“隐含预设”带来的假阳性。
  - 最低两组（建议都做 A vs B）：
    - **M消融**：`M={}`（或全部置零） → 若 A>B 信号主要靠 M 通道，应显著退化。
    - **C消融**：`C={}`（或全部置零） → 若 A>B 信号主要靠群体态，应显著退化。
  - 输出：把“消融前后”主指标差异（均值/中位数/分位数 + p值 + 效应量）写入裁决摘要。

- **G3.4 IN/OUT 同向性审计（B阶段v2强制）**
  - 目的：把“Top权重列表”推进到更像机制的证据：同一输入通道在 OUT/IN 两套网络里方向一致。
  - 方法：在关键人群（至少：`alive`、`winner_abs`、`winner_anchor`）上：
    - 按 |Cohen’s d| 选 Top-N 权重（建议 N≥50）
    - 对 W1 权重按 `(feature_idx, hidden_idx)` 将 OUT 与 IN 配对
    - 检查 `sign(delta_OUT) == sign(delta_IN)` 的比例
  - 通过条件（建议工程线）：`consistency_rate >= 0.8` 且 `n_pairs` 充分（例如 ≥ 20）
  - 输出必须落盘并写入裁决摘要（含 pairs_top 示例）

- **G3.5 赢家人群分层稳定性（B阶段v3）**
  - 目的：验证“赢家机制”在不同强度层（交易数/胜率/信号强度）下仍稳定，而非单点偶然。
  - 方法：在 **锚定赢家**（anchor winner）集合内，对以下维度做分层（推荐三分位）：
    - `total_trades`
    - `win_rate`
    - `last_signal`
  - **v3.1（强制兜底：分箱退化时启用）**
    - 触发条件：若某个分层维度出现分位点退化（切点重复/空箱/绝大多数样本集中导致分箱无效），不得硬解释为“机制不存在”。
    - 处理方式：必须启用更稳健的分箱尺子之一，并在裁决中落盘声明所用方法与阈值：
      - `log1p(x)` 后分箱，或
      - 固定阈值分箱（由“样本下限”驱动选择阈值，而不是拍脑袋）
    - 目标：让该分层维度在每个有效箱内满足 Gate 3.5 的样本下限要求（见下）。
  - 每个分箱要求：`nA>=30` 且 `nB>=30` 才纳入结论；样本不足/退化分箱必须显式标注为“无效证据”，不得硬解释。
  - 通过条件（建议工程线）：在有效分箱中，同向性（G3.4）保持高一致（例如 ≥0.8），且关键通道重复出现（允许少量波动，但不得完全翻盘）。
  - 输出：给出每个分箱的样本量、同向性、Top通道摘要。

---

## 5. Gate 4：走向虚拟盘/实盘的最低可用门槛（非盈利门槛）

通过 Gate 1–3 之后，才讨论是否进入虚拟盘/实盘工程。

- **G4.1 运行稳定**
  - 无刷屏、无溢出、无长期无意义循环（崩溃后应停止或只打印一次）。

- **G4.2 产物可管理**
  - 所有关键指标落盘、可聚合、可复核（不靠grep挖日志）。

- **G4.3 执行环境指纹测试（若上OKX demo/live）**
  - 以极小额订单测量：滑点分布、部分成交比例、延迟分布、fee一致性，并落盘。

- **G4.4 “生态围栏 ≠ 状态机”隔离原则（强制）**
  - 目的：防止系统在产品化阶段偷偷变成“人为策略”，破坏演化自由度与证据链可比性。
  - 一句话解释（产品化落地）：**阈值可以存在，但只作为“事后标签/审计口径/生死规则/外壳限流”；决策仍必须是 `Genome + Features -> Action`（不允许把阈值掺进决策路径来“指导”交易）。**
  - 强制规则：
    - **生态围栏**（如无风险基准/季度淘汰与繁殖门槛/资金守恒与崩溃重启/执行摩擦与资源上限）只能进入：
      - 生命周期层（death/repro/collapse/reboot）
      - 审计层（指标口径、分群标签、告警与回放）
      - 外壳限流层（例如最大频率/最大挂单数/kill switch），但不得改变“基因表达规则”
    - **禁止**把生态阈值直接写进状态机/决策路径（例如“signal>阈值才允许进场/加仓/减仓”这类硬门槛），除非该阈值被明确声明为“世界物理约束”（如交易所规则/保证金/强平）。
  - 审计要求（必须落盘）：
    - 每次运行必须写入 `run_manifest`/`summary.meta`：当期生态围栏配置（rf来源/阈值/执行环境指纹版本/限流参数）。
    - 若发现决策路径依赖新增生态阈值：Gate 4 **Fail**，必须回退或将其降级为“审计标签/生命周期规则”。

- **G4.5 执行接口对齐审计（CCXT/OKX SDK）（强制）**
  - 目的：防止“基因学到的是接口差异/实现细节”，而非市场结构；保证 V10 的基因表达与特征口径在产品化执行层仍可复核。
  - **关键口径：两个世界不能混裁（强制）**
    - **B阶段（离线实验世界）**：I/M 等特征来自系统内部状态与内部摩擦模型，因此“可得”；消融与A/B2裁决只在该世界内成立。
    - **C阶段（执行接口世界）**：I（positions）与 M（fills/fees/latency）必须从交易所/库返回获取；若 demo 不提供/不可靠，必须 `null + reason` 或标记 `simulated`，并给出 fallback 证据链。**不得因为 demo 缺失而倒推 B 阶段消融结论无效。**
  - **自成交（self-trade / self-cross）风险（强制：先记录，再扩展）**
    - 风险：同一账户下多 Agent/多循环同时交易同一合约时，可能发生“我们自己的买单和卖单互相成交”，导致虚假成交量与手续费损耗，并污染学习/归因。
    - 最低要求（必须落盘）：
      - `run_manifest` 记录：是否支持/启用 STP（Self-Trade Prevention）、是否做执行净额/聚合、以及当前检测能力强弱。
      - raw evidence（如 `m_execution_raw.json`）保留最小字段以支持事后检测（脱敏可）。
    - 说明：此条是执行层“世界物理约束/风险”，属于审计与外壳执行策略，不得渗入 core 决策路径。
  - 强制规则：
    - 必须通过 **统一适配层（adapter）** 接入交易所；业务逻辑不得散落依赖 CCXT/SDK 的原始字段名。
    - 必须在 `run_manifest/summary.meta` 记录：`exchange_lib`（ccxt/okx_sdk）、`exchange_id`（okx）、`env`（demo/live）、`symbol_in_use`（实际使用的symbol）、以及 `connect_check_ok`。
    - **切换执行库（ccxt ↔ okx_sdk）视为世界差异**：需做最小回归验证（至少 Gate 4 的执行指纹与“活着指标”仍可落盘且口径不漂移；必要时回归 Gate 1）。
  - 落盘要求（必须提供“证据包”，脱敏可）：
    - `ccxt_alignment_report.json`（或等价）：字段映射表、缺失字段的降级策略、已知风险点（posSide/tdMode/fee/partial fill等）
    - `ccxt_raw_samples.json`（或等价）：至少包含 ticker/ohlcv/orderbook/positions/balance/order/trade 的原始响应样例（敏感字段置空）
  - 通过条件（建议工程线）：
    - `okx_demo_api` 模式下 `api_calls > 0` 且 `connect_check_ok=true`
    - 对齐证据包存在并被 run_manifest 引用
    - 关键字段缺失时必须 `null + reason`，不得伪装为真实可得

---

## 6. 最终裁决输出格式（强制）

每轮验收必须输出“一页裁决摘要”（Markdown或JSON均可）：

- Gate 0–4：逐项 **Pass/Fail**（Fail必须给原因与复核路径/命令）
- A vs B：主指标的均值/中位数/分位数 + p值 + 效应量
- 结论：**通过 / 不通过 / 证据不足**
- 下一步：只允许提出**最小改动**（优先补证据，不优先改世界规则）

---

## 7. 待确认项（剩余需锁定）

- **对照组B的生成方式与参数**：默认采用“打乱log-return重建价格”的方案。
- **最小效应量阈值**：例如system_roi差异≥2pp、盈利人数差异≥50%等。


