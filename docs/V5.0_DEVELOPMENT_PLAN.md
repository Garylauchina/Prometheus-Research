# Prometheus-Quant v5.0 开发计划

## 📅 创建日期: 2025-12-04

## 🎯 版本目标（2025-12-04更新）

**v5.0 核心目标：完全重构的Agent系统 + 双熵系统**

v5.0实际完成的核心系统：

### ✅ 目标1: 双熵系统（Dual Entropy System）- 已完成
- **血统（Lineage）**: 家族来源追溯，50维向量表示 ✅
- **基因组（Genome）**: 50个策略参数，4层解锁机制 ✅
- **血统熵**: 监控家族分布多样性（Shannon熵）✅
- **基因熵**: 监控策略参数多样性（方差）✅
- **验血系统**: PrometheusBloodLab高层API ✅

### ✅ 目标2: Agent完全重构 - 已完成 ⭐ v5.0核心
- **Instinct（本能系统）**: 一级本能（死亡恐惧）+ 二级本能（5个） ✅
- **Strategy（策略系统）**: 3个策略，可扩展 ✅
- **PersonalInsights（记忆系统）**: 学习、冥思、顿悟 ✅
- **Daimon（守护神）**: 6个声音投票机制 ✅
- **AgentV5**: 模块化、可测试、不向后兼容 ✅

### ⏳ 目标3: 系统集成 - 进行中
- **Supervisor适配**: 支持AgentV5 ⏳
- **EvolutionManager适配**: 支持v5.0遗传 ⏳
- **完整测试**: 500+代进化测试 ⏳

### 📅 推迟到v5.1+的功能
- **高级风控系统** - 夏普比率、最大回撤、VaR等（v5.1）
- **先知期权监控** - Mastermind监控相关市场（v5.2）
- **Elysium系统** - 大灭绝恢复机制（v5.2）
- **BulletinBoard增强** - 记忆功能（v5.1）
- **Daimon记忆** - 反馈学习、元认知（v5.1-v6.0）

### ❌ 已取消的功能
- **族谱系统（GenealogyTree）** - 已被双熵系统替代

**设计理念**: v5.0完全重构Agent，建立坚实的模块化架构，为后续智能增强铺路

---

## 📋 v4.3 → v5.0 迁移检查清单

### ✅ v4.3 完成状态
- [x] 基因多样性修复（0.00 → 0.12+）
- [x] 系统总盈亏显示功能
- [x] 日志输出优化（减少60%冗余）
- [x] 进化系统稳定运行（已测试722代）
- [x] 参数解锁机制验证

### 📦 v4.3 需要提交的内容
```bash
# 已修改但未提交的文件
- prometheus/core/evolution_manager.py (基因多样性修复)
- prometheus/core/supervisor.py (系统盈亏显示)
- examples/v4_okx_simplified_launcher.py (日志优化)
```

---

## 🚀 执行步骤

### Phase 1: v4.3 收尾（今天完成）

#### Step 1: 检查当前状态
```bash
git status
git log --oneline -5
```

#### Step 2: 确认所有修改已提交
```bash
# 如果有未提交的修改
git add .
git commit -m "chore: 最终v4.3优化"
git push origin develop/v4.0
```

#### Step 3: 创建v4.3.0标签
```bash
# 在develop/v4.0分支上打标签
git tag -a v4.3.0 -m "v4.3.0 稳定版

核心修复:
- 修复基因多样性计算BUG（0.00 → 0.12+）
- 修复evolution_manager中Agent列表访问错误

新增功能:
- 每周期显示系统总盈亏（实盈+浮盈）
- 高级风控指标基础

输出优化:
- 修复日志重复输出问题
- Agent排名显示优化（前5+后3）
- 日志量减少约60%

测试验证:
- 已通过722代长时间测试
- 基因多样性稳定在0.12
- 参数解锁机制正常工作"

# 推送标签到远程
git push origin v4.3.0

# 查看所有标签
git tag -l
```

#### Step 4: （可选）合并到main分支
```bash
# 如果需要发布到主分支
git checkout main
git merge develop/v4.0
git push origin main
```

---

### Phase 2: 项目重命名（今天完成）

#### Step 1: 在GitHub上重命名仓库
1. 访问 https://github.com/Garylauchina/prometheus-v30
2. 点击 **Settings**
3. 在 **Repository name** 中改为 `Prometheus-Quant`
4. 点击 **Rename**

#### Step 2: 更新本地远程地址
```bash
# 更新远程仓库URL
git remote set-url origin https://github.com/Garylauchina/Prometheus-Quant.git

# 验证
git remote -v

# 测试连接
git fetch origin
```

#### Step 3: 更新项目文档
- [ ] 更新 README.md 中的项目名称
- [ ] 更新所有文档中的项目引用
- [ ] 更新日志文件路径（如果需要）

---

### Phase 3: 创建v5.0开发分支（今天完成）

```bash
# 基于当前develop/v4.0创建v5.0分支
git checkout develop/v4.0
git pull origin develop/v4.0

# 创建新分支
git checkout -b develop/v5.0

# 推送到远程
git push origin develop/v5.0

# 设置上游分支
git branch --set-upstream-to=origin/develop/v5.0 develop/v5.0
```

---

## 🎯 v5.0 功能开发时间表

### 🏁 Phase 0: 族谱系统（已完成 ✅）

**状态**: 已完成并集成

**已交付**:
- ✅ `prometheus/core/genealogy.py` - 族谱系统核心模块
- ✅ `GenealogyTree` - 完整的血缘追踪
- ✅ 精确亲缘系数计算（BFS算法）
- ✅ 生殖隔离机制
- ✅ 集成到`evolution_manager.py`
- ✅ 集成到`supervisor.py`

---

### 🚀 Phase 1: 双熵系统核心（第1周，12月5日-12月11日）

**目标**: 实现Lineage和Genome的向量化表示

#### Day 1-2: Lineage系统
**里程碑**:
- [ ] 创建`prometheus/core/lineage.py`
- [ ] 实现`LineageVector`类
  - 18维向量表示
  - `create_genesis()` - 创世血统
  - `create_child()` - Beta混合 + 高斯漂移
  - `compute_kinship()` - Bhattacharyya系数
  - `_normalize()` - L1归一化
- [ ] 单元测试

**交付物**:
```python
# prometheus/core/lineage.py
class LineageVector:
    def __init__(self, dimensions=18)
    @classmethod
    def create_genesis(cls, family_index)
    @classmethod
    def create_child(cls, parent1, parent2, drift_strength=0.01)
    def compute_kinship(self, other)
    def get_dominant_families(self, threshold=0.05)
    def classify_purity(self)
```

#### Day 3-4: Genome系统
**里程碑**:
- [ ] 创建`prometheus/core/genome.py`
- [ ] 实现`GenomeVector`类
  - 50维向量表示
  - `from_dict()` / `to_dict()` - 与EvolvableGene转换
  - `crossover()` - 向量化交叉
  - `mutate()` - 向量化变异
  - `unlock_param()` - 参数解锁
- [ ] 单元测试

**交付物**:
```python
# prometheus/core/genome.py
class GenomeVector:
    PARAM_ORDER = ['risk_appetite', 'trend_pref', ...]  # 全局顺序
    MAX_PARAMS = 50
    
    def __init__(self, max_dimensions=50)
    @classmethod
    def from_dict(cls, params)
    def to_dict(self)
    def crossover(self, other)
    def mutate(self, mutation_rate=0.5, mutation_strength=0.2)
    def unlock_param(self, param_name, initial_value=None)
```

#### Day 5-7: 双熵计算
**里程碑**:
- [ ] 创建`prometheus/core/dual_entropy.py`
- [ ] 实现血统熵计算（Shannon熵）
- [ ] 实现基因熵计算（方差法）
- [ ] 实现`DualEntropyHealthSystem`
- [ ] 单元测试

**交付物**:
```python
# prometheus/core/dual_entropy.py
def calculate_lineage_entropy(agents, family_count) -> Dict
def calculate_gene_entropy_variance(agents) -> Dict
def calculate_gene_entropy_discretized(agents, bins=10) -> Dict

class DualEntropyHealthSystem:
    def comprehensive_health_check(self, agents)
    def _assess_lineage_health(self, normalized_entropy)
    def _assess_gene_health(self, normalized_entropy)
    def _generate_recommendations(self, lineage_health, gene_health)
```

---

### 🔗 Phase 2: 系统集成（第2周，12月12日-12月18日）

**目标**: 将双熵系统集成到现有架构

#### Day 1-3: Agent重构
**里程碑**:
- [ ] 修改`prometheus/core/agent_v4.py`
- [ ] 添加`self.lineage`和`self.genome`属性
- [ ] 实现向量↔dict同步机制
- [ ] 更新`create_child()`方法
- [ ] 向后兼容性测试

**修改要点**:
```python
class AgentV5:  # 重命名为V5
    def __init__(self, agent_id, ...):
        # 新增
        self.lineage = LineageVector()
        self.genome = GenomeVector()
        
        # 兼容层（可选保留）
        self.gene = self._create_evolvable_gene_view()
```

#### Day 4-5: EvolutionManager集成
**里程碑**:
- [ ] 修改`prometheus/core/evolution_manager.py`
- [ ] 使用LineageVector进行快速亲缘筛选
- [ ] 使用GenomeVector进行交叉变异
- [ ] 集成双熵健康检查
- [ ] 基于双熵调整进化参数

**修改要点**:
```python
class EvolutionManager:
    def __init__(self, supervisor):
        self.health_system = DualEntropyHealthSystem(family_count=50)
    
    def _select_compatible_parents(self):
        # 快速筛选：使用lineage.compute_kinship()
        # 精确验证：使用genealogy_tree.can_mate()
    
    def run_evolution_cycle(self):
        # 进化前后双熵对比
        # 自适应调整变异率
```

#### Day 6-7: Supervisor集成
**里程碑**:
- [ ] 修改`prometheus/core/supervisor.py`
- [ ] Genesis时初始化Lineage和Genome
- [ ] 每N周期显示双熵报告
- [ ] 集成到性能报告
- [ ] 完整测试

**修改要点**:
```python
class Supervisor:
    def _genesis_create_agents(self):
        # 为每个Agent分配初始lineage
        # 从EvolvableGene转换为GenomeVector
    
    def run_cycle(self):
        if cycle_count % 50 == 0:
            self._display_dual_entropy_report()
```

---

### 🧪 Phase 3: 测试与优化（第3周，12月19日-12月25日）

**目标**: 全面测试和性能优化

#### Day 1-3: 单元测试
- [ ] `tests/test_lineage.py` - Lineage数学正确性
- [ ] `tests/test_genome.py` - Genome操作正确性
- [ ] `tests/test_dual_entropy.py` - 熵计算准确性
- [ ] 覆盖率 > 80%

#### Day 4-5: 集成测试
- [ ] 完整进化周期测试（100代）
- [ ] 双熵稳定性测试
- [ ] 性能基准测试（对比v4.3）
- [ ] 向后兼容性验证

#### Day 6-7: 文档完善
- [ ] `docs/V5.0_DUAL_ENTROPY_SYSTEM.md` - 系统文档
- [ ] `docs/V5.0_LINEAGE_AND_GENOME.md` - 技术文档
- [ ] `docs/V5.0_MIGRATION_FROM_V4.md` - 迁移指南
- [ ] API参考文档
- [ ] 代码注释完善

---

## 📊 v5.0 成功指标

### ✅ 族谱系统（已达成）
- [x] 可以追溯任意Agent的完整血缘
- [x] 亲缘系数计算准确率 = 100%（BFS精确算法）
- [x] 生殖隔离有效防止近亲繁殖

### 🎯 双熵系统（v5.0 目标）

#### 功能指标
- [ ] Lineage和Genome向量化完成
- [ ] 血统熵和基因熵准确计算
- [ ] 双熵健康评估系统运行
- [ ] 与现有系统完全集成

#### 性能指标
- [ ] 亲缘计算速度提升 > 10× （15μs → 1-2μs）
- [ ] 多样性计算速度提升 > 10× （100μs → 10μs）
- [ ] 内存占用增加 < 30% （可接受）

#### 质量指标
- [ ] 血统熵稳定在 3.0-5.5 bits 范围
- [ ] 基因熵稳定在 0.10-0.25 范围
- [ ] 有效家族数 > 40% （20/50）
- [ ] 可交配率 > 95%

#### 测试指标
- [ ] 单元测试覆盖率 > 80%
- [ ] 集成测试通过率 = 100%
- [ ] 长期稳定性测试 > 500代
- [ ] 向后兼容性验证通过

---

## 🔧 技术栈

### 核心依赖（v5.0已有）
```txt
numpy>=1.24.0      # 向量运算核心
ccxt>=4.0.0        # 交易所API
python-dotenv>=1.0.0  # 环境配置
```

### v5.0 新增依赖
```txt
scipy>=1.10.0      # Bhattacharyya系数、统计计算
```

### 可选依赖（推荐用于开发）
```txt
pytest>=7.0.0      # 单元测试
pytest-cov>=4.0.0  # 测试覆盖率
```

### v5.0 配置更新
```python
# config/config.py 新增
V5_DUAL_ENTROPY_CONFIG = {
    # 血统系统
    'lineage': {
        'family_count': 50,           # 家族数量（固定）
        'kinship_threshold': 0.85,    # 生殖隔离阈值
        'drift_strength': 0.01,       # 血统漂移强度
    },
    
    # 基因组系统
    'genome': {
        'max_params': 50,             # 最大参数数量
        'initial_unlock': 3,          # 初始解锁参数
        'mutation_rate': 0.5,         # 变异率
        'mutation_strength': 0.2,     # 变异强度
    },
    
    # 双熵监控
    'dual_entropy': {
        'monitor_interval': 50,       # 监控间隔（周期）
        'lineage_warning': 0.4,       # 血统熵警告阈值（归一化）
        'lineage_critical': 0.3,      # 血统熵危险阈值
        'gene_warning': 0.05,         # 基因熵警告阈值
        'gene_critical': 0.03,        # 基因熵危险阈值
        'enable_auto_adjust': True,   # 启用自动调整进化参数
    },
}
```

---

## 📝 文档计划

### 需要创建的文档
- [ ] `docs/V5.0_MIGRATION_GUIDE.md` - v4.3 → v5.0迁移指南
- [ ] `docs/V5.0_ARCHITECTURE.md` - v5.0架构设计
- [ ] `docs/V5.0_API_REFERENCE.md` - API参考
- [ ] `docs/V5.0_USER_GUIDE.md` - 用户指南

### 需要更新的文档
- [ ] `README.md` - 更新项目介绍
- [ ] `docs/V4.0_ROADMAP.md` - 标记为已完成
- [ ] `CHANGELOG.md` - 添加v5.0变更记录

---

## 🎯 下一步行动

### ✅ 已完成:
1. ✅ 族谱系统实现（`genealogy.py`）
2. ✅ 集成到进化系统
3. ✅ 双熵系统设计完成
4. ✅ v5.0开发计划更新

### 🔄 立即开始（Phase 1, Day 1-2）:

#### Day 1: Lineage系统
```bash
# 1. 创建文件
touch prometheus/core/lineage.py
touch tests/test_lineage.py

# 2. 实现LineageVector类
# - 18维向量表示
# - create_genesis()
# - create_child() with Beta混合
# - compute_kinship() with Bhattacharyya系数
# - _normalize() L1归一化

# 3. 单元测试
pytest tests/test_lineage.py -v
```

#### Day 2: Genome系统
```bash
# 1. 创建文件
touch prometheus/core/genome.py
touch tests/test_genome.py

# 2. 实现GenomeVector类
# - 50维向量 + 解锁掩码
# - from_dict() / to_dict()
# - crossover() 向量化
# - mutate() 向量化

# 3. 单元测试
pytest tests/test_genome.py -v
```

### 📅 本周计划（12月5日-12月11日）:
- Day 1-2: ✅ Lineage + Genome 实现
- Day 3-4: 🔄 双熵计算模块
- Day 5-6: 🔄 DualEntropyHealthSystem
- Day 7: 🔄 Phase 1 验收测试

---

## 💡 注意事项

1. **保持v4.3稳定性**: v5.0开发期间，v4.3保持在develop/v4.0分支，可继续修复bug
2. **向后兼容**: v5.0应尽可能兼容v4.3的配置和数据格式
3. **增量开发**: 每个功能独立开发和测试，完成后再合并
4. **文档先行**: 每个功能开发前先设计API和文档

---

## 🎉 v5.0 预期成果

### 核心架构升级
v5.0 完成后，Prometheus-Quant将拥有：

1. **完整的遗传学基础**
   - ✅ 族谱系统：100%准确的血缘追踪
   - ✅ 双熵系统：全面的多样性监控
   - ✅ 向量化架构：10-50倍性能提升

2. **双重多样性保障**
   - 血统熵：防止近亲化，确保家族多样性
   - 基因熵：防止策略趋同，确保参数多样性
   - 双轨监控：实时健康评估和干预建议

3. **可扩展的进化平台**
   - 清晰的架构分层（Lineage + Genome + Entropy）
   - 为v5.1高级风控铺路
   - 为v5.2多市场支持铺路

### 技术指标
- 亲缘计算速度：1-2μs（15×提升）
- 多样性计算速度：10μs（10×提升）
- 血统熵：3.0-5.5 bits（健康范围）
- 基因熵：0.10-0.25（健康范围）
- 可交配率：>95%

### 开发价值
- 代码质量：单元测试覆盖率 >80%
- 文档完善：完整的API和技术文档
- 架构清晰：概念层与实现层分离
- 易于维护：模块化设计，低耦合

---

## 📚 关键文档

### v5.0 核心文档
- `docs/V5.0_DEVELOPMENT_PLAN.md` - 本文档
- `docs/V5.0_GENEALOGY_IMPLEMENTATION.md` - 族谱系统实现报告
- `docs/V5.0_DUAL_ENTROPY_SYSTEM.md` - 双熵系统详细设计（待创建）
- `docs/V5.0_LINEAGE_AND_GENOME.md` - 技术实现文档（待创建）

### 设计讨论记录
- 血统 vs 基因组：概念澄清
- 双熵系统：数学基础和实现方案
- 大灭绝恢复：文明重建理念（推迟到v5.2）
- Elysium系统：历史博物馆设计（推迟到v5.2）

---

*文档创建: 2025-12-04*  
*最后更新: 2025-12-04*  
*项目: Prometheus-Quant v5.0*  
*作者: Gary & AI*

