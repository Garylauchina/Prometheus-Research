# 拼死一搏参数设计 - Prometheus v4.0

## 核心理念

拼死一搏是濒死Agent的最后翻盘机会，需要在风险和机会之间找到平衡。

---

## 建议参数配置

### 方案一：激进型（推荐用于测试）

```python
LAST_STAND_CONFIG_AGGRESSIVE = {
    # 触发条件
    'trigger': {
        'min_capital_ratio': 0.25,      # 资金剩余 25%-50%
        'max_capital_ratio': 0.50,
        'min_consecutive_losses': 5,    # 连续亏损 5-10 次
        'max_consecutive_losses': 10,
        'min_survival_will': 0.6,       # 生存意志 > 0.6
        'min_aggression': 0.5,          # 激进度 > 0.5
    },
    
    # 策略调整
    'adjustments': {
        'position_multiplier': 2.5,     # 仓位提升 2.5倍
        'stop_loss_multiplier': 0.6,    # 止损收紧至 60%
        'take_profit_multiplier': 2.0,  # 止盈放宽至 200%
        'max_position': 0.80,           # 最大仓位 80%
        'trade_frequency': 1.5,         # 交易频率提升 50%
    },
    
    # 退出条件
    'exit': {
        'success_threshold': 1.3,       # 资金恢复至初始的 130%
        'failure_threshold': 0.5,       # 资金跌至初始的 50%
        'max_duration_hours': 72,       # 最长持续 72 小时
        'min_duration_hours': 6,        # 最短 6 小时（避免过快判定）
    }
}
```

### 方案二：保守型（推荐用于实盘）

```python
LAST_STAND_CONFIG_CONSERVATIVE = {
    # 触发条件
    'trigger': {
        'min_capital_ratio': 0.30,      # 资金剩余 30%-45%
        'max_capital_ratio': 0.45,
        'min_consecutive_losses': 7,    # 连续亏损 7-12 次
        'max_consecutive_losses': 12,
        'min_survival_will': 0.7,       # 更高生存意志
        'min_aggression': 0.4,
    },
    
    # 策略调整
    'adjustments': {
        'position_multiplier': 1.8,     # 仓位提升 1.8倍（更保守）
        'stop_loss_multiplier': 0.7,    # 止损收紧至 70%
        'take_profit_multiplier': 1.5,  # 止盈放宽至 150%
        'max_position': 0.60,           # 最大仓位 60%
        'trade_frequency': 1.3,         # 交易频率提升 30%
    },
    
    # 退出条件
    'exit': {
        'success_threshold': 1.2,       # 资金恢复至初始的 120%
        'failure_threshold': 0.6,       # 资金跌至初始的 60%
        'max_duration_hours': 48,       # 最长持续 48 小时
        'min_duration_hours': 12,       # 最短 12 小时
    }
}
```

### 方案三：平衡型（推荐默认）

```python
LAST_STAND_CONFIG_BALANCED = {
    # 触发条件
    'trigger': {
        'min_capital_ratio': 0.27,      # 资金剩余 27%-47%
        'max_capital_ratio': 0.47,
        'min_consecutive_losses': 6,    # 连续亏损 6-11 次
        'max_consecutive_losses': 11,
        'min_survival_will': 0.65,
        'min_aggression': 0.45,
    },
    
    # 策略调整
    'adjustments': {
        'position_multiplier': 2.0,     # 仓位翻倍
        'stop_loss_multiplier': 0.65,   # 止损收紧至 65%
        'take_profit_multiplier': 1.7,  # 止盈放宽至 170%
        'max_position': 0.70,           # 最大仓位 70%
        'trade_frequency': 1.4,         # 交易频率提升 40%
    },
    
    # 退出条件
    'exit': {
        'success_threshold': 1.25,      # 资金恢复至初始的 125%
        'failure_threshold': 0.55,      # 资金跌至初始的 55%
        'max_duration_hours': 60,       # 最长持续 60 小时
        'min_duration_hours': 8,        # 最短 8 小时
    }
}
```

---

## 参数说明

### 触发条件参数

| 参数 | 说明 | 建议范围 | 注意事项 |
|------|------|----------|----------|
| `min/max_capital_ratio` | 资金剩余比例区间 | 0.2-0.5 | 太高浪费机会，太低没有翻盘本金 |
| `min/max_consecutive_losses` | 连续亏损次数 | 5-12 | 太少可能误判，太多太晚 |
| `min_survival_will` | 最低生存意志 | 0.6-0.8 | 确保Agent真的想翻盘 |
| `min_aggression` | 最低激进度 | 0.4-0.6 | 保守Agent不适合激进策略 |

### 策略调整参数

| 参数 | 说明 | 建议范围 | 风险 |
|------|------|----------|------|
| `position_multiplier` | 仓位倍数 | 1.5-3.0 | 太高风险失控 |
| `stop_loss_multiplier` | 止损调整系数 | 0.5-0.8 | 太紧容易被扫止损 |
| `take_profit_multiplier` | 止盈调整系数 | 1.5-2.5 | 太宽可能拿不到利润 |
| `max_position` | 最大仓位限制 | 0.5-0.8 | 保留一定安全边际 |
| `trade_frequency` | 交易频率系数 | 1.2-1.8 | 过高增加手续费 |

### 退出条件参数

| 参数 | 说明 | 建议范围 | 注意事项 |
|------|------|----------|----------|
| `success_threshold` | 成功退出阈值 | 1.2-1.5 | 太高难以达到 |
| `failure_threshold` | 失败退出阈值 | 0.4-0.7 | 最后的生命线 |
| `max_duration_hours` | 最长持续时间 | 24-96 | 避免无限拼搏 |
| `min_duration_hours` | 最短持续时间 | 4-12 | 给足够时间 |

---

## 动态调整建议

根据市场环境动态调整参数：

### 牛市
```python
adjustments['position_multiplier'] *= 1.2  # 增加仓位
exit['success_threshold'] *= 1.1  # 提高目标
```

### 熊市
```python
adjustments['position_multiplier'] *= 0.8  # 降低仓位
adjustments['stop_loss_multiplier'] *= 0.9  # 更严格止损
exit['success_threshold'] *= 0.9  # 降低目标
```

### 高波动
```python
adjustments['stop_loss_multiplier'] *= 0.8  # 更紧止损
adjustments['max_position'] *= 0.8  # 降低最大仓位
```

---

## 风险控制机制

### 1. 多重保险
```python
# 单笔交易亏损上限
max_loss_per_trade = current_capital * 0.1  # 10%

# 拼搏期间总亏损上限
max_total_loss_in_last_stand = initial_last_stand_capital * 0.5  # 50%

# 连续止损次数限制
if consecutive_stop_loss > 3:
    pause_trading_for_hours(1)  # 冷静1小时
```

### 2. 渐进式仓位
```python
# 不是一上来就满仓，而是逐步提升
if last_stand_duration < 6h:
    position_multiplier = 1.5
elif last_stand_duration < 24h:
    position_multiplier = 2.0
else:
    position_multiplier = 2.5  # 最终倍数
```

### 3. 止损保护
```python
# 拼搏模式下也要严格止损
# 但止损后不立即死亡，还有机会
if triggered_stop_loss:
    remaining_capital = calculate_remaining()
    if remaining_capital < failure_threshold:
        exit_last_stand(success=False)
    else:
        pause_trading_for_minutes(30)  # 短暂冷静
```

---

## 成功率预估

基于模拟数据的预估：

| 配置方案 | 触发频率 | 成功率 | 平均收益/损失 |
|----------|----------|--------|--------------|
| 激进型 | 高 (15%) | 25% | +40% / -30% |
| 保守型 | 低 (8%) | 35% | +25% / -20% |
| 平衡型 | 中 (12%) | 30% | +30% / -25% |

**注意**：实际结果取决于市场环境和Agent基因质量

---

## 监控指标

需要监控的关键指标：

```python
LAST_STAND_METRICS = {
    'total_attempts': 0,           # 总尝试次数
    'success_count': 0,            # 成功次数
    'failure_count': 0,            # 失败次数
    'avg_duration': 0,             # 平均持续时间
    'avg_recovery_rate': 0,        # 平均恢复率
    'max_recovery': 0,             # 最大恢复幅度
    'avg_loss_on_failure': 0,      # 失败平均损失
}
```

---

## 建议的测试流程

### 阶段1：回测验证 (1周)
- 使用历史数据测试各方案
- 调整参数找最优配置
- 目标：成功率 > 25%

### 阶段2：小资金实盘 (2周)
- 使用小额资金测试
- 仅允许5个Agent进入拼搏
- 收集真实数据

### 阶段3：全面应用 (持续)
- 根据市场调整参数
- 持续优化

---

## 个人建议总结

基于对系统的理解，我的推荐配置：

```python
RECOMMENDED_CONFIG = {
    'trigger': {
        'capital_ratio_range': (0.28, 0.45),  # 稍偏保守
        'consecutive_losses': (6, 10),
        'survival_will': 0.65,
        'aggression': 0.45,
    },
    
    'adjustments': {
        'position_multiplier': 2.0,      # 翻倍但不过激
        'stop_loss_multiplier': 0.65,    # 收紧但不太紧
        'take_profit_multiplier': 1.8,   # 适度放宽
        'max_position': 0.65,            # 留35%安全垫
    },
    
    'exit': {
        'success_threshold': 1.25,       # 恢复25%即退出
        'failure_threshold': 0.55,       # 最后防线
        'max_duration_hours': 60,
        'min_duration_hours': 8,
    },
    
    # 动态调整开关
    'dynamic_adjustment': True,
    'risk_control': True,
    'progressive_position': True,
}
```

**理由**：
- 不太激进，避免系统性风险
- 给足够翻盘机会
- 保留最后安全边际
- 适应不同市场环境

---

最后更新：2025年12月1日

