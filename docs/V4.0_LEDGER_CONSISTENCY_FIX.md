# ğŸ”§ Prometheus v4.0 è´¦åŠ¡ä¸€è‡´æ€§ä¿®å¤

## ğŸ“… ä¿®å¤æ—¶é—´
**2025-12-03**

---

## ğŸ” é—®é¢˜è¯Šæ–­

ç”¨æˆ·åé¦ˆï¼š**"åˆæ³¨æ„åˆ°å¾ˆå¤šä¸ªè´¦åŠ¡ä¸ä¸€è‡´ç°è±¡"**

### **å‘ç°çš„æ ¹æœ¬é—®é¢˜**

#### **é—®é¢˜1ï¼šTradeRecordç¼ºå°‘å…³é”®å­—æ®µ** âŒ

**æ—§çš„TradeRecord**ï¼š
```python
@dataclass
class TradeRecord:
    agent_id: str
    trade_id: str
    trade_type: str  # 'buy', 'sell', 'short', 'cover'
    amount: float
    price: float
    timestamp: datetime
    confidence: float
    pnl: Optional[float] = None
    is_real: bool = True
    # âŒ ç¼ºå°‘position_sideå­—æ®µ
    # âŒ ç¼ºå°‘okx_order_idå­—æ®µ
```

**é—®é¢˜**ï¼š
- åœ¨åŒå‘æŒä»“æ¨¡å¼ä¸‹ï¼Œæ— æ³•åŒºåˆ†äº¤æ˜“æ˜¯é’ˆå¯¹å¤šä»“è¿˜æ˜¯ç©ºä»“
- å¯¹è´¦æ—¶æ— æ³•ç²¾ç¡®åŒ¹é…OKXçš„å…·ä½“è®¢å•
- **å¯¼è‡´å¯¹è´¦æ—¶å‡ºç°"å­¤å„¿è®¢å•"å’Œ"è´¦ç°¿ä¸ä¸€è‡´"è­¦å‘Š**

---

#### **é—®é¢˜2ï¼šä½¿ç”¨ä¼°ç®—ä»·æ ¼è€Œéå®é™…æˆäº¤ä»·** âŒ

**Supervisorå½“å‰é€»è¾‘**ï¼š
```python
# ç¬¬1æ­¥ï¼šæ‰§è¡ŒOKXäº¤æ˜“
order = self.okx_trading.place_market_order(...)

# ç¬¬2æ­¥ï¼šè®°è´¦ï¼ˆâŒ ä½¿ç”¨ä¼°ç®—ä»·æ ¼ï¼‰
if order:
    account.record_trade(
        price=current_price,  # âŒ tickerä»·æ ¼ï¼ˆä¼°ç®—ï¼‰
        ...
    )
```

**é—®é¢˜**ï¼š
- `current_price`æ˜¯ä»tickerè·å–çš„æœ€æ–°ä»·æ ¼
- å¸‚ä»·å•çš„**å®é™…æˆäº¤ä»·æ ¼**å¯èƒ½ä¸åŒï¼ˆæ»‘ç‚¹ï¼‰
- **å¯¼è‡´è´¦ç°¿è®°å½•çš„ä»·æ ¼ä¸OKXå®é™…æˆäº¤ä»·æ ¼ä¸ä¸€è‡´**

---

#### **é—®é¢˜3ï¼šå¯¹è´¦æ—¶æœºä¸å¤Ÿé¢‘ç¹** â°

**å½“å‰é€»è¾‘**ï¼š
```python
# åªåœ¨æ’åæ—¶å¯¹è´¦ï¼ˆæ¯10ä¸ªå‘¨æœŸï¼‰
if self.cycle_count % 10 == 0:
    self._reconcile_with_okx(current_price)
```

**é—®é¢˜**ï¼š
- è´¦åŠ¡ä¸ä¸€è‡´å¯èƒ½ç´¯ç§¯10ä¸ªå‘¨æœŸæ‰è¢«å‘ç°
- **å»ºè®®**ï¼šæ¯ç¬”äº¤æ˜“åç«‹å³è½»é‡çº§éªŒè¯

---

## ğŸ› ï¸ å®æ–½çš„ä¿®å¤

### **ä¿®å¤1ï¼šå¢å¼ºTradeRecordæ•°æ®ç»“æ„** âœ…

**æ–°çš„TradeRecord**ï¼š
```python
@dataclass
class TradeRecord:
    agent_id: str
    trade_id: str
    trade_type: str  # 'buy', 'sell', 'short', 'cover', 'add', 'add_short'
    amount: float
    price: float
    timestamp: datetime
    confidence: float
    pnl: Optional[float] = None
    is_real: bool = True
    
    # âœ… æ–°å¢å­—æ®µ
    position_side: Optional[str] = None  # 'long' or 'short'ï¼ˆæ˜ç¡®ä»“ä½æ–¹å‘ï¼‰
    okx_order_id: Optional[str] = None   # OKXè®¢å•IDï¼ˆç²¾ç¡®å¯¹è´¦ï¼‰
```

**æ”¹è¿›ç‚¹**ï¼š
1. **`position_side`**ï¼šæ˜ç¡®æ ‡è¯†äº¤æ˜“é’ˆå¯¹å“ªä¸ªä»“ä½ï¼ˆå¤šä»“/ç©ºä»“ï¼‰
2. **`okx_order_id`**ï¼šå­˜å‚¨OKXçš„è®¢å•IDï¼Œç”¨äºç²¾ç¡®å¯¹è´¦

---

### **ä¿®å¤2ï¼šè‡ªåŠ¨è®°å½•position_side** âœ…

**PrivateLedgerå››ä¸ªæ–¹æ³•çš„æ”¹è¿›**ï¼š

```python
# record_buy: ä¹°å…¥æ€»æ˜¯å½±å“å¤šå¤´
trade = TradeRecord(
    ...
    position_side='long',  # âœ… æ˜ç¡®æ ‡è¯†
    okx_order_id=okx_order_id
)

# record_sell: å–å‡ºæ€»æ˜¯å¹³å¤šå¤´
trade = TradeRecord(
    ...
    position_side='long',  # âœ… æ˜ç¡®æ ‡è¯†
    okx_order_id=okx_order_id
)

# record_short: å¼€ç©ºæ€»æ˜¯å½±å“ç©ºå¤´
trade = TradeRecord(
    ...
    position_side='short',  # âœ… æ˜ç¡®æ ‡è¯†
    okx_order_id=okx_order_id
)

# record_cover: å¹³ç©ºæ€»æ˜¯å½±å“ç©ºå¤´
trade = TradeRecord(
    ...
    position_side='short',  # âœ… æ˜ç¡®æ ‡è¯†
    okx_order_id=okx_order_id
)
```

---

### **ä¿®å¤3ï¼šAgentAccountSystemä¼ é€’okx_order_id** âœ…

**AgentAccountSystem.record_tradeæ–°ç­¾å**ï¼š
```python
def record_trade(self, trade_type: str, amount: float, price: float, 
                 confidence: float, is_real=True,
                 caller_role: Role = Role.SUPERVISOR, 
                 okx_order_id: str = None):  # âœ… æ–°å¢å‚æ•°
    """
    Args:
        price: äº¤æ˜“ä»·æ ¼ï¼ˆåº”ä½¿ç”¨OKXå®é™…æˆäº¤ä»·æ ¼ï¼‰â† å¼ºè°ƒ
        okx_order_id: OKXè®¢å•IDï¼ˆç”¨äºç²¾ç¡®å¯¹è´¦ï¼‰â† æ–°å¢
    """
    # ä¼ é€’ç»™PrivateLedger
    if trade_type == 'buy':
        self.private_ledger.record_buy(
            ..., 
            okx_order_id=okx_order_id  # âœ… ä¼ é€’
        )
    # ... å…¶ä»–trade_typeåŒæ ·å¤„ç†
```

---

## ğŸ“‹ **Supervisoréœ€è¦åšçš„æ”¹è¿›ï¼ˆå¾…å®æ–½ï¼‰**

### **æ”¹è¿›1ï¼šä½¿ç”¨OKXå®é™…æˆäº¤ä»·æ ¼** ğŸ”§

**å½“å‰ä»£ç ï¼ˆéœ€è¦ä¿®æ”¹ï¼‰**ï¼š
```python
order = self.okx_trading.place_market_order(...)
if order:
    account.record_trade(
        price=current_price,  # âŒ åº”è¯¥æ”¹ä¸º order['average'] æˆ– order['price']
        ...
    )
```

**å»ºè®®ä¿®æ”¹ä¸º**ï¼š
```python
order = self.okx_trading.place_market_order(...)
if order:
    # ä»orderä¸­æå–å®é™…æˆäº¤ä»·æ ¼
    actual_price = order.get('average') or order.get('price') or current_price
    okx_order_id = order.get('id')  # æå–è®¢å•ID
    
    account.record_trade(
        price=actual_price,       # âœ… ä½¿ç”¨å®é™…æˆäº¤ä»·
        okx_order_id=okx_order_id,  # âœ… ä¼ é€’è®¢å•ID
        ...
    )
```

**ä¼˜åŠ¿**ï¼š
- è´¦ç°¿è®°å½•çš„ä»·æ ¼ä¸OKXå®Œå…¨ä¸€è‡´
- ç›ˆäºè®¡ç®—æ›´ç²¾ç¡®
- å¯¹è´¦æ—¶ä¸ä¼šå› ä¸ºä»·æ ¼å¾®å°å·®å¼‚è€ŒæŠ¥è­¦

---

### **æ”¹è¿›2ï¼šéªŒè¯è®¢å•ç¡®å®æˆåŠŸ** ğŸ”§

**å½“å‰ä»£ç ï¼ˆéœ€è¦å¢å¼ºï¼‰**ï¼š
```python
order = self.okx_trading.place_market_order(...)
if order:  # âŒ åªæ£€æŸ¥orderä¸ä¸ºNone
    account.record_trade(...)
```

**å»ºè®®å¢å¼ºä¸º**ï¼š
```python
order = self.okx_trading.place_market_order(...)
if order and order.get('status') in ['closed', 'filled']:  # âœ… ç¡®è®¤æˆåŠŸ
    actual_price = order.get('average') or order.get('price') or current_price
    okx_order_id = order.get('id')
    
    account.record_trade(
        price=actual_price,
        okx_order_id=okx_order_id,
        ...
    )
    return True
else:
    # äº¤æ˜“å¤±è´¥ï¼Œä¸è®°è´¦ï¼ˆä¿æŒè´¦ç°¿ä¸OKXä¸€è‡´ï¼‰
    logger.error(f"{agent_id}: äº¤æ˜“å¤±è´¥ï¼Œæœªè®°è´¦ - {order}")
    return False
```

**ä¼˜åŠ¿**ï¼š
- åªæœ‰ç¡®è®¤æˆåŠŸçš„è®¢å•æ‰è®°è´¦
- é¿å…"è´¦ç°¿æœ‰è®°å½•ä½†OKXæ— è®¢å•"çš„ä¸ä¸€è‡´

---

### **æ”¹è¿›3ï¼šæ¯ç¬”äº¤æ˜“åç«‹å³éªŒè¯** ğŸ”§

**å»ºè®®åœ¨äº¤æ˜“åç«‹å³éªŒè¯**ï¼š
```python
order = self.okx_trading.place_market_order(...)
if order and order.get('status') in ['closed', 'filled']:
    # è®°è´¦
    account.record_trade(...)
    
    # âœ… ç«‹å³è½»é‡çº§éªŒè¯
    self._quick_verify_single_trade(agent_id, okx_order_id)
```

**è½»é‡çº§éªŒè¯æ–¹æ³•**ï¼š
```python
def _quick_verify_single_trade(self, agent_id: str, okx_order_id: str):
    """
    å•ç¬”äº¤æ˜“åç«‹å³éªŒè¯ï¼ˆè½»é‡çº§ï¼‰
    
    åªéªŒè¯ï¼š
    1. è¯¥è®¢å•æ˜¯å¦åœ¨OKXå­˜åœ¨
    2. è®¢å•çŠ¶æ€æ˜¯å¦æ­£ç¡®
    3. è®¢å•é‡‘é¢æ˜¯å¦åŒ¹é…
    """
    # ä»OKXè·å–è®¢å•è¯¦æƒ…
    okx_order = self.okx_trading.fetch_order(okx_order_id)
    
    # ä»ç§æœ‰è´¦ç°¿è·å–æœ€åä¸€ç¬”äº¤æ˜“
    account = self.agent_accounts.get(agent_id)
    last_trade = account.private_ledger.trade_history[-1]
    
    # æ¯”å¯¹
    if abs(okx_order['amount'] - last_trade.amount) > 0.001:
        logger.error(f"{agent_id}: äº¤æ˜“é‡‘é¢ä¸åŒ¹é…ï¼è´¦ç°¿:{last_trade.amount} OKX:{okx_order['amount']}")
        # ç«‹å³ä¿®æ­£æˆ–å›æ»š
```

---

## ğŸ¯ **è®°è´¦æ ¸å¿ƒåŸåˆ™**

æ ¹æ®æ‚¨çš„å»ºè®®ï¼Œæˆ‘ä»¬æ€»ç»“å‡ºä»¥ä¸‹æ ¸å¿ƒåŸåˆ™ï¼š

### **âœ… è®°è´¦ä¸‰å¤§åŸåˆ™**

1. **Supervisorç»Ÿä¸€è®°è´¦**
   - æ‰€æœ‰äº¤æ˜“ç”±Supervisoræ‰§è¡ŒOKXæ“ä½œåç»Ÿä¸€è®°è´¦
   - ä¸å…è®¸Agentç›´æ¥ä¿®æ”¹è´¦ç°¿ï¼ˆé€šè¿‡æƒé™æ§åˆ¶å®ç°ï¼‰

2. **åŒè´¦ç°¿åŒæ­¥æ›´æ–°**
   - `AgentAccountSystem.record_trade`åŒæ—¶æ›´æ–°ä¸¤æœ¬è´¦ç°¿
   - ä½¿ç”¨åŒä¸€ä¸ª`TradeRecord`å¯¹è±¡ï¼Œç¡®ä¿`trade_id`ä¸€è‡´

3. **å®Œæ•´çš„äº¤æ˜“ä¿¡æ¯**
   - **Agent ID**ï¼šæ˜ç¡®äº¤æ˜“å±äºå“ªä¸ªAgent
   - **Trade ID**ï¼šå”¯ä¸€æ ‡è¯†ï¼ˆæ ¼å¼ï¼š`{agent_id}_{timestamp}`ï¼‰
   - **Position Side**ï¼šæ˜ç¡®ä»“ä½æ–¹å‘ï¼ˆ'long' or 'short'ï¼‰
   - **OKX Order ID**ï¼šå…³è”OKXè®¢å•ï¼Œç”¨äºç²¾ç¡®å¯¹è´¦
   - **å®é™…æˆäº¤ä»·æ ¼**ï¼šè€Œéä¼°ç®—ä»·æ ¼

---

## ğŸ§ª **è¿˜éœ€è¦æ³¨æ„çš„ç‚¹**

æ ¹æ®æ‚¨çš„é—®é¢˜ï¼Œä»¥ä¸‹æ˜¯é¢å¤–éœ€è¦æ³¨æ„çš„è¦ç‚¹ï¼š

### **1. æ—¶é—´æˆ³ç²¾åº¦** â°

**å½“å‰**ï¼š
```python
trade_id = f"{self.agent_id}_{datetime.now().strftime('%Y%m%d%H%M%S')}"
```

**é—®é¢˜**ï¼šå¦‚æœ1ç§’å†…æœ‰å¤šç¬”äº¤æ˜“ï¼Œ`trade_id`å¯èƒ½é‡å¤

**å»ºè®®**ï¼š
```python
# æ–¹æ³•1ï¼šå¢åŠ æ¯«ç§’
trade_id = f"{self.agent_id}_{datetime.now().strftime('%Y%m%d%H%M%S%f')}"

# æ–¹æ³•2ï¼šä½¿ç”¨UUID
import uuid
trade_id = f"{self.agent_id}_{uuid.uuid4().hex[:8]}"

# æ–¹æ³•3ï¼šä½¿ç”¨è®¡æ•°å™¨
trade_id = f"{self.agent_id}_{self.trade_count}_{datetime.now().strftime('%Y%m%d%H%M%S')}"
```

---

### **2. äº‹åŠ¡æ€§ï¼ˆTransactionï¼‰** ğŸ”’

**ç†æƒ³æµç¨‹**ï¼š
```python
try:
    # 1. æ‰§è¡ŒOKXäº¤æ˜“
    order = self.okx_trading.place_market_order(...)
    
    if not order or order.get('status') != 'closed':
        raise Exception("äº¤æ˜“å¤±è´¥")
    
    # 2. è®°å½•åˆ°ç§æœ‰è´¦ç°¿
    account.private_ledger.record_buy(...)
    
    # 3. è®°å½•åˆ°å…¬å…±è´¦ç°¿
    self.public_ledger.record_trade(last_trade)
    
except Exception as e:
    # å›æ»šæ‰€æœ‰æ“ä½œ
    logger.error(f"äº¤æ˜“å¤±è´¥ï¼Œå›æ»š: {e}")
    # å¦‚æœç§æœ‰è´¦ç°¿å·²è®°å½•ï¼Œéœ€è¦åˆ é™¤
    if account.private_ledger.trade_history:
        account.private_ledger.trade_history.pop()
    return False
```

---

### **3. å¹¶å‘å®‰å…¨** ğŸ”

**å½“å‰ç³»ç»Ÿ**ï¼šå•çº¿ç¨‹è¿è¡Œï¼Œæ— å¹¶å‘é—®é¢˜

**æœªæ¥æ‰©å±•**ï¼šå¦‚æœå¼•å…¥å¤šçº¿ç¨‹/å¼‚æ­¥ï¼Œéœ€è¦åŠ é”ï¼š
```python
import threading

class AgentAccountSystem:
    def __init__(self, ...):
        ...
        self._lock = threading.Lock()
    
    def record_trade(self, ...):
        with self._lock:  # åŠ é”ï¼Œç¡®ä¿åŸå­æ€§
            # è®°è´¦é€»è¾‘
            ...
```

---

### **4. å¯¹è´¦é¢‘ç‡å»ºè®®** ğŸ“Š

| å¯¹è´¦ç±»å‹ | æ—¶æœº | å¼€é”€ | ç›®çš„ |
|---------|------|------|------|
| **è½»é‡çº§éªŒè¯** | æ¯ç¬”äº¤æ˜“å | ä½ | ç«‹å³å‘ç°å¼‚å¸¸ |
| **ä¸­åº¦å¯¹è´¦** | æ¯10ç¬”äº¤æ˜“ | ä¸­ | å®šæœŸæ£€æŸ¥ä¸€è‡´æ€§ |
| **æ·±åº¦å¯¹è´¦** | æ¯50å‘¨æœŸ | é«˜ | å…¨é¢å¯¹è´¦+è‡ªåŠ¨ä¿®æ­£ |
| **å…¨é‡å¯¹è´¦** | ç³»ç»Ÿå¯åŠ¨æ—¶ | æé«˜ | å´©æºƒæ¢å¤ |

---

## ğŸ“ˆ **é¢„æœŸæ•ˆæœ**

å®æ–½æœ¬æ¬¡ä¿®å¤åï¼š

âœ… **è´¦ç°¿ä¸€è‡´æ€§æå‡**
- TradeRecordåŒ…å«å®Œæ•´ä¿¡æ¯ï¼ˆposition_side, okx_order_idï¼‰
- å¯¹è´¦æ—¶èƒ½ç²¾ç¡®åŒ¹é…è®¢å•
- å‡å°‘"å­¤å„¿è®¢å•"å’Œ"è´¦ç°¿ä¸ä¸€è‡´"è­¦å‘Š

âœ… **ä»·æ ¼ç²¾åº¦æå‡**
- ä½¿ç”¨OKXå®é™…æˆäº¤ä»·æ ¼ï¼ˆå¾…Supervisorå®æ–½ï¼‰
- ç›ˆäºè®¡ç®—æ›´å‡†ç¡®

âœ… **é—®é¢˜å‘ç°æ›´åŠæ—¶**
- æ¯ç¬”äº¤æ˜“åç«‹å³éªŒè¯ï¼ˆå¾…å®æ–½ï¼‰
- å¼‚å¸¸èƒ½åœ¨1ä¸ªå‘¨æœŸå†…è¢«å‘ç°å’Œä¿®æ­£

---

## ğŸ”„ **ä¸‹ä¸€æ­¥è¡ŒåŠ¨**

### **ç«‹å³æµ‹è¯•**
1. âœ… TradeRecordå­—æ®µå·²å¢å¼º
2. âœ… PrivateLedgerå·²æ›´æ–°
3. âœ… AgentAccountSystemå·²æ›´æ–°
4. â³ **Supervisoréœ€è¦ä¿®æ”¹**ï¼ˆä½¿ç”¨å®é™…æˆäº¤ä»·æ ¼å’Œè®¢å•IDï¼‰
5. â³ **æ·»åŠ æ¯ç¬”äº¤æ˜“åçš„è½»é‡çº§éªŒè¯**

### **å»ºè®®çš„Supervisorä¿®æ”¹æ¸…å•**
- [ ] ä»`order`å¯¹è±¡æå–`actual_price`å’Œ`okx_order_id`
- [ ] ä¼ é€’ç»™`account.record_trade()`
- [ ] æ·»åŠ `_quick_verify_single_trade()`æ–¹æ³•
- [ ] å¢å¼ºè®¢å•çŠ¶æ€éªŒè¯ï¼ˆç¡®è®¤æˆåŠŸåæ‰è®°è´¦ï¼‰

---

## ğŸ“ ç›¸å…³æ–‡æ¡£

- **ä¸»æ–‡æ¡£**ï¼š`docs/V4.0_ROADMAP.md`
- **è´¦ç°¿ç³»ç»Ÿè®¾è®¡**ï¼š`prometheus/core/ledger_system.py`
- **åäºæŸä¼˜åŒ–**ï¼š`docs/V4.0_ANTI_LOSS_OPTIMIZATION.md`

---

*ä¿®å¤å®Œæˆæ—¶é—´ï¼š2025-12-03 23:00*  
*Supervisoræ”¹è¿›å¾…å®æ–½ â³*

