# Prometheus v3.0 - 故障排查与踩坑记录

**版本**: 1.0  
**日期**: 2025年11月29日

---

## 1. 故障排查哲学：像侦探一样思考

> "当排除了所有不可能，剩下的无论多么不合情理，也必然是真相。" - 夏洛克·福尔摩斯

排查问题时，遵循以下原则：

1.  **查看日志**: 日志是第一现场，90%的线索都在里面。
2.  **隔离问题**: 尝试复现问题，缩小范围。是代码问题还是环境问题？是策略问题还是API问题？
3.  **大胆假设，小心求证**: 提出可能性，然后用实验去验证。
4.  **记录一切**: 记录问题现象、排查过程和解决方案，形成知识库。

---

## 2. 常见问题与解决方案 (FAQ)

### Q1: 系统无法启动，提示 `ModuleNotFoundError`

-   **现象**: `ModuleNotFoundError: No module named 'okx'`
-   **原因**: Python依赖未安装或虚拟环境未激活。
-   **解决方案**:
    1.  确保已激活虚拟环境: `source venv/bin/activate`
    2.  安装依赖: `pip install -r requirements.txt`

### Q2: API调用失败，提示 `Invalid API Key` 或 `Authentication error`

-   **现象**: 日志中出现大量API认证错误。
-   **原因**: API凭证配置错误。
-   **解决方案**:
    1.  检查`.env`文件中的`OKX_API_KEY`, `OKX_SECRET_KEY`, `OKX_PASSPHRASE`是否正确。
    2.  确认API密钥是否已过期或被禁用。
    3.  确认API权限是否包含"读取"和"交易"。
    4.  检查IP白名单设置是否正确。

### Q3: 服务在后台运行一段时间后自动停止

-   **现象**: `sudo systemctl status prometheus.service` 显示 `inactive (dead)`。
-   **原因**: 
    1.  **内存不足 (OOM Killer)**: 系统内存耗尽，内核杀死了最耗内存的进程。
    2.  **代码中的致命错误**: 未被捕获的异常导致程序崩溃。
    3.  **网络长时间中断**: 导致API调用连续失败，程序退出。
-   **解决方案**:
    1.  查看系统日志: `sudo journalctl -u prometheus.service -n 100`，查找错误信息。
    2.  检查内存使用: `free -h`，考虑升级VPS内存或优化代码。
    3.  检查`Restart=always`是否已在`.service`文件中配置。

### Q4: 系统运行正常，但一直不交易

-   **现象**: 日志正常，但`Total trades`一直为0。
-   **原因**: 
    1.  **市场处于震荡状态**: 未达到策略的交易阈值。
    2.  **交易阈值设置过高**: `long_threshold`和`short_threshold`过于保守。
    3.  **资金不足**: 账户余额不足以满足最小下单量。
-   **解决方案**:
    1.  耐心等待，市场可能确实没有交易机会。
    2.  在模拟盘中适当降低交易阈值进行测试。
    3.  检查交易所对目标交易对的最小下单量要求。

### Q5: 如何重置系统并清除所有数据？

-   **现象**: 想从一个全新的状态开始测试。
-   **解决方案**:
    1.  停止服务: `sudo systemctl stop prometheus.service`
    2.  删除日志: `rm -rf trading_logs/*`
    3.  在OKX模拟盘手动平仓并划转所有资金。
    4.  重启服务: `sudo systemctl start prometheus.service`

---

## 3. 踩坑记录 (Lessons Learned)

### 3.1 OKX API的中文Passphrase编码问题

-   **问题**: 在v3.0初次测试中，使用了中文作为Passphrase，导致API签名验证失败，错误为 `UnicodeEncodeError: 'ascii' codec can't encode characters`。
-   **原因**: OKX Python SDK在进行HMAC-SHA256签名时，未正确处理非ASCII字符，默认使用了ASCII编码。
-   **解决方案**: **永远不要使用中文或特殊字符作为API Passphrase**。必须使用纯英文和数字。
-   **教训**: 
    -   不要想当然地认为所有系统都支持UTF-8。
    -   对于涉及加密和签名的部分，务必使用最简单、最通用的字符集。

### 3.2 仓位模式不匹配导致的平仓失败

-   **问题**: 在v3.0测试中，尝试平仓时API返回错误，提示"没有该方向的持仓"。
-   **原因**: OKX合约账户有**开平仓模式**和**买卖模式**。如果API调用中的`posSide`参数与账户设置不匹配，将无法正确执行订单。
-   **解决方案**: 
    1.  在API调用中明确指定`posSide` (`long`或`short`)。
    2.  确保账户的持仓模式与代码逻辑一致。
-   **教训**: 
    -   在与交易所API交互时，必须仔细阅读其文档，特别是关于账户设置和交易模式的部分。
    -   不要忽略API返回的每一个错误信息，它们是排查问题的关键线索。

### 3.3 遗传算法在震荡市中的"过度拟合"

-   **问题**: 在v1.0的回测中，发现某些在牛市中表现极好的Agent，在震荡市中亏损严重。
-   **原因**: 这些Agent的基因"过度拟合"了牛市的趋势行情，它们的交易阈值非常低，导致在震荡市中被反复"打脸"。
-   **解决方案**: 引入**市场状态检测**机制（v2.5），在震荡市中"抑制"这些激进的Agent，降低它们的交易频率和资金分配。
-   **教训**: 
    -   **没有一种策略能适应所有市场**。系统的适应性比单个策略的优越性更重要。
    -   必须有机制来识别和应对不同的市场环境。

### 3.4 初始Agent多样性不足

-   **问题**: 如果初始Agent的基因过于相似，遗传算法可能过早地收敛到一个局部最优解，而错过了全局最优解。
-   **原因**: 随机数生成器的种子问题或基因初始化范围太窄。
-   **解决方案**: 
    1.  确保基因参数的初始化范围足够宽。
    2.  引入一定的"突变"概率，即使在没有繁殖的情况下，Agent的基因也有小概率发生随机变化。
-   **教训**: 
    -   **多样性是进化的前提**。必须在系统的整个生命周期中保持种群的多样性。
    -   在利用（exploitation）已知优势策略和探索（exploration）未知可能性之间取得平衡。

---

## 4. 如何记录新的问题

当您遇到新的问题时，请按照以下格式记录到本文件中，以便未来参考：

```markdown
### [问题标题]

-   **问题**: [问题的简要描述]
-   **原因**: [经过排查后发现的根本原因]
-   **解决方案**: [解决问题的具体步骤]
-   **教训**: [从这次经历中学到的经验或教训]
```

---

*本文档由Manus AI生成*  
*最后更新: 2025-11-29*
