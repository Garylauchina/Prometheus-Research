# v5.7 重构需求清单

**目标时间**: 2026年Q4（v6.0前）  
**目标**: 为v6.0质变打造干净基础  
**原则**: 不把技术债带入v6.0！⭐

---

## 📋 重构需求收集

> **重要**: 在v5.3-v5.6开发期间，遇到任何"应该重构但暂时不改"的问题，
> 都记录在这里，等v5.7统一处理！

---

## 🗑️ 待清理的过时代码

### 过时版本
```
待确认（v5.6后决定）：
- [ ] agent.py (v3.0) - 是否完全被v5替代？
- [ ] agent_v4.py (v4.0) - 保留or归档？
- [ ] mastermind.py - 还在使用吗？
- [ ] 其他v3-v4模块

决策依据：
- v5.3-v5.6开发中，哪些旧模块完全未使用
- 记录最后使用时间
```

### 重复代码
```
已知：
- [ ] evolution_manager.py vs evolution_manager_v5.py
      → 相似度95%，需要提取基类

待发现：
- [ ] v5.3-v5.6开发中发现的重复代码
- [ ] 记录在这里
```

### 实验性代码
```
- [ ] 注释掉的大段代码（如果超过3个月未用）
- [ ] 调试用的临时代码
- [ ] 未完成的实验模块
```

---

## 📝 待规范化的代码

### 命名不统一
```
发现日期 | 文件 | 问题 | 建议
---------|------|------|------
(等待积累)
```

### 缺少类型注解
```
优先级高的模块（核心功能）：
- [ ] evolution_manager_v5.py
- [ ] agent_v5.py
- [ ] diversity_monitor.py
- [ ] diversity_protection.py
- [ ] 其他核心模块（v5.6后补充）
```

### 缺少文档字符串
```
- [ ] 所有公共API
- [ ] 关键内部方法
- [ ] 复杂算法
```

### 错误处理不统一
```
- [ ] 统一异常体系设计
- [ ] 统一日志格式
- [ ] 统一错误恢复策略
```

---

## 🏗️ 架构优化需求

### 待提取的基类
```
1. BaseAgent
   - agent.py
   - agent_v4.py  
   - agent_v5.py
   共同逻辑：?（v5.6后分析）

2. BaseEvolutionManager
   - evolution_manager.py
   - evolution_manager_v5.py
   共同逻辑：?（v5.6后分析）

3. BaseMarket
   - simple_opponents.py
   - advanced_market.py
   共同接口：?（v5.6后分析）

4. 其他（待发现）
```

### 需要应用的设计模式
```
- [ ] Strategy模式（交易策略）
- [ ] Observer模式（事件通知）
- [ ] Factory模式（Agent创建）
- [ ] Singleton模式（配置管理）
- [ ] 其他（开发中发现）
```

### 依赖关系问题
```
- [ ] 循环依赖（如果发现）
- [ ] 过度耦合（如果发现）
- [ ] 需要解耦的模块
```

---

## ⚡ 性能优化需求

### 计算性能
```
发现日期 | 函数/模块 | 问题 | 预期提升
---------|----------|------|----------
(等待积累)

示例：
2025.12 | calculate_diversity | 重复计算 | 30%
```

### 内存占用
```
发现日期 | 问题 | 严重程度
---------|------|----------
(等待积累)
```

### I/O效率
```
- [ ] 数据库批量操作
- [ ] 文件读写优化
- [ ] 网络请求优化
```

---

## 🧪 测试覆盖补充

### 缺少单元测试的模块
```
优先级 | 模块 | 当前覆盖率 | 目标
-------|------|------------|------
高 | (待补充) | ? | 80%+
中 | (待补充) | ? | 70%+
低 | (待补充) | ? | 60%+
```

### 缺少集成测试的场景
```
- [ ] 端到端测试
- [ ] 并发场景测试
- [ ] 极端情况测试
```

---

## 📊 待重构的大文件

### 当前超过1000行的文件
```
文件 | 行数 | 是否需要拆分 | 拆分方案
-----|------|--------------|----------
trading_system.py | 3,602 | ? | (v5.6后评估)
supervisor.py | 3,364 | ? | (v5.6后评估)
agent_v4.py | 1,842 | ? | (v5.6后评估)
ledger_system.py | 1,749 | ? | (v5.6后评估)
mastermind.py | 1,405 | ? | (v5.6后评估)
```

**评估标准**:
- 单一职责？
- 是否可拆分？
- 拆分收益 vs 成本

---

## 🎯 v5.3-v5.6期间的行动

### 1. 持续记录
```
遇到以下情况时，记录到本文件：
✅ 发现过时代码（但暂时不删）
✅ 发现重复代码（但暂时不合并）
✅ 发现性能问题（但暂时不优化）
✅ 发现命名问题（但暂时不改）
✅ 发现架构问题（但暂时不重构）

原则：
- 不影响开发进度
- 但要记录清楚
- 等v5.7统一处理
```

### 2. 小清理
```
可以顺手做的（不影响进度）：
✅ 删除明显无用的代码
✅ 修复明显的命名错误
✅ 添加必要的注释
✅ 格式化代码

不要做的（留给v5.7）：
❌ 大规模重构
❌ 改变架构
❌ 重写核心模块
```

---

## 📅 v5.7重构时间表（预计）

```
2026年10月（4周）
├─ Week 1-2: 代码审计
│   ├─ 依赖分析
│   ├─ 复杂度分析
│   ├─ 重复代码检测
│   └─ 制定详细计划
│
├─ Week 3-4: 清理过时代码
│   ├─ 删除v3-v4过时模块
│   ├─ 合并重复代码
│   └─ 清理实验代码

2026年11月（4周）
├─ Week 1-2: 规范化
│   ├─ 添加类型注解
│   ├─ 统一文档字符串
│   └─ 统一错误处理
│
├─ Week 3-4: 架构优化
│   ├─ 提取基类
│   ├─ 应用设计模式
│   └─ 依赖注入

2026年12月（4周）
├─ Week 1-2: 性能优化 + 测试
│   ├─ 计算优化
│   ├─ 内存优化
│   └─ 测试覆盖提升
│
├─ Week 3: 文档整理
│   ├─ API文档
│   ├─ 架构图
│   └─ 开发指南
│
└─ Week 4: 验证和发布
    ├─ 回归测试
    ├─ 性能测试
    └─ v5.7 Release

总计：12周（3个月）
```

---

## ✅ 成功标准

### 代码质量
```
- [ ] 代码行数减少10-20%（清理冗余）
- [ ] 类型注解覆盖率 > 80%
- [ ] 文档字符串覆盖率 100%
- [ ] 代码复杂度降低30%
- [ ] 无pylint严重警告
```

### 架构质量
```
- [ ] 无循环依赖
- [ ] 模块耦合度低
- [ ] 接口清晰统一
- [ ] 设计模式应用合理
```

### 性能
```
- [ ] 执行速度提升30-50%
- [ ] 内存占用降低20-30%
- [ ] 无明显性能瓶颈
```

### 测试
```
- [ ] 单元测试覆盖率 > 80%
- [ ] 集成测试覆盖核心流程
- [ ] 所有测试通过
- [ ] 回归测试通过
```

### 文档
```
- [ ] API文档完整
- [ ] 架构图清晰
- [ ] 开发指南详细
- [ ] 注释充分
```

---

## 💡 持续更新

### 更新规则
```
时机：
- 每次发现"应该重构但暂时不改"的问题
- 每完成一个v5.x版本后
- 定期回顾（每月）

格式：
- 日期 + 问题描述 + 位置 + 优先级

优先级：
- P0: 严重问题，v5.7必须解决
- P1: 重要问题，v5.7优先解决  
- P2: 一般问题，v5.7尽量解决
- P3: 次要问题，视情况处理
```

---

## 🎯 最终目标

```
通过v5.7重构，实现：

1. 干净的代码库 ✨
   - 无过时代码
   - 无重复代码
   - 规范统一

2. 清晰的架构 🏗️
   - 层次分明
   - 职责清晰
   - 易于扩展

3. 高效的性能 ⚡
   - 快速执行
   - 低内存占用
   - 无性能瓶颈

4. 完善的测试 🧪
   - 高覆盖率
   - 全面场景
   - 自动化

5. 优质的文档 📚
   - API清晰
   - 架构明确
   - 易于理解

目的：
为v6.0质变提供坚实的基础！
不把技术债带入下一代！⭐⭐⭐⭐⭐
```

---

**创建时间**: 2025-12-06  
**下次审查**: v5.3完成后  
**状态**: 🟢 持续收集中

**重要提醒**: 
> 在v5.3-v5.6开发时，专注功能！
> 遇到"应该改但暂时不改"的问题，记录在这里！
> v5.7会统一彻底解决！💪

