#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""æµ‹è¯•èµ„é‡‘è´¹ç‡æ¨¡å‹"""

import sys
sys.path.insert(0, '.')

import logging
from prometheus.core.funding_rate_model import (
    FundingRateModel,
    simulate_market_funding_rate,
    MarketSentiment
)

# é…ç½®æ—¥å¿—
logging.basicConfig(
    level=logging.DEBUG,
    format='[%(levelname)s] %(message)s'
)

print("="*80)
print("èµ„é‡‘è´¹ç‡æ¨¡å‹æµ‹è¯• - v5.1")
print("="*80)

model = FundingRateModel()

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# åœºæ™¯1ï¼šä¸­æ€§å¸‚åœºï¼ˆåˆçº¦ä»·æ ¼=ç°è´§ä»·æ ¼ï¼‰
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
print("\n[åœºæ™¯1] ä¸­æ€§å¸‚åœº - åˆçº¦ä»·æ ¼â‰ˆç°è´§ä»·æ ¼")
print("-"*80)

result1 = model.calculate_funding_rate(
    mark_price=50000.0,    # åˆçº¦ä»·æ ¼
    index_price=50000.0,   # ç°è´§ä»·æ ¼
    long_short_ratio=1.0,  # å¤šç©ºå¹³è¡¡
)

print(f"\næ ‡è®°ä»·æ ¼: $50,000")
print(f"æŒ‡æ•°ä»·æ ¼: $50,000")
print(f"æº¢ä»·æŒ‡æ•°: {result1.premium_index:.4%}")
print(f"\nâœ… èµ„é‡‘è´¹ç‡: {result1.funding_rate:.4%} (8å°æ—¶)")
print(f"   å¹´åŒ–è´¹ç‡: {result1.annualized_rate:.2%}")
print(f"   å¸‚åœºæƒ…ç»ª: {result1.market_sentiment.value}")
print(f"\næŒä»“æˆæœ¬ï¼ˆ$10,000ä»“ä½/8å°æ—¶ï¼‰:")
print(f"   å¤šå¤´: ${result1.long_cost_8h:+.2f}")
print(f"   ç©ºå¤´: ${result1.short_cost_8h:+.2f}")


# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# åœºæ™¯2ï¼šåå¤šå¸‚åœºï¼ˆåˆçº¦ä»·æ ¼ > ç°è´§ä»·æ ¼ï¼‰
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
print("\n[åœºæ™¯2] åå¤šå¸‚åœº - åˆçº¦æº¢ä»·+1%")
print("-"*80)

result2 = model.calculate_funding_rate(
    mark_price=50500.0,    # åˆçº¦ä»·æ ¼ +1%
    index_price=50000.0,   # ç°è´§ä»·æ ¼
    long_short_ratio=1.5,  # å¤šç©ºæ¯”1.5ï¼ˆæ›´å¤šäººåšå¤šï¼‰
)

print(f"\næ ‡è®°ä»·æ ¼: $50,500 (+1.0%)")
print(f"æŒ‡æ•°ä»·æ ¼: $50,000")
print(f"æº¢ä»·æŒ‡æ•°: {result2.premium_index:.4%}")
print(f"å¤šç©ºæ¯”: 1.5:1")
print(f"\nâœ… èµ„é‡‘è´¹ç‡: {result2.funding_rate:.4%} (8å°æ—¶)")
print(f"   å¹´åŒ–è´¹ç‡: {result2.annualized_rate:.2%}")
print(f"   å¸‚åœºæƒ…ç»ª: {result2.market_sentiment.value}")
print(f"\næŒä»“æˆæœ¬ï¼ˆ$10,000ä»“ä½/8å°æ—¶ï¼‰:")
print(f"   å¤šå¤´: ${result2.long_cost_8h:+.2f} ğŸ’¸ (å¤šå¤´æ”¯ä»˜)")
print(f"   ç©ºå¤´: ${result2.short_cost_8h:+.2f} ğŸ’° (ç©ºå¤´æ”¶å–)")

daily_long_cost = model.estimate_daily_cost(10000, "long", result2.funding_rate)
print(f"\nğŸ“Š å¤šå¤´æ¯æ—¥æˆæœ¬: ${daily_long_cost:+.2f}")


# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# åœºæ™¯3ï¼šåç©ºå¸‚åœºï¼ˆåˆçº¦ä»·æ ¼ < ç°è´§ä»·æ ¼ï¼‰
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
print("\n[åœºæ™¯3] åç©ºå¸‚åœº - åˆçº¦æŠ˜ä»·-0.8%")
print("-"*80)

result3 = model.calculate_funding_rate(
    mark_price=49600.0,    # åˆçº¦ä»·æ ¼ -0.8%
    index_price=50000.0,   # ç°è´§ä»·æ ¼
    long_short_ratio=0.6,  # å¤šç©ºæ¯”0.6ï¼ˆæ›´å¤šäººåšç©ºï¼‰
)

print(f"\næ ‡è®°ä»·æ ¼: $49,600 (-0.8%)")
print(f"æŒ‡æ•°ä»·æ ¼: $50,000")
print(f"æº¢ä»·æŒ‡æ•°: {result3.premium_index:.4%}")
print(f"å¤šç©ºæ¯”: 0.6:1")
print(f"\nâœ… èµ„é‡‘è´¹ç‡: {result3.funding_rate:.4%} (8å°æ—¶)")
print(f"   å¹´åŒ–è´¹ç‡: {result3.annualized_rate:.2%}")
print(f"   å¸‚åœºæƒ…ç»ª: {result3.market_sentiment.value}")
print(f"\næŒä»“æˆæœ¬ï¼ˆ$10,000ä»“ä½/8å°æ—¶ï¼‰:")
print(f"   å¤šå¤´: ${result3.long_cost_8h:+.2f} ğŸ’° (å¤šå¤´æ”¶å–)")
print(f"   ç©ºå¤´: ${result3.short_cost_8h:+.2f} ğŸ’¸ (ç©ºå¤´æ”¯ä»˜)")

daily_short_cost = model.estimate_daily_cost(10000, "short", result3.funding_rate)
print(f"\nğŸ“Š ç©ºå¤´æ¯æ—¥æˆæœ¬: ${daily_short_cost:+.2f}")


# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# åœºæ™¯4ï¼šæç«¯å¤šå¤´å¸‚åœºï¼ˆé«˜æº¢ä»·ï¼‰
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
print("\n[åœºæ™¯4] æç«¯å¤šå¤´å¸‚åœº - åˆçº¦æº¢ä»·+3%")
print("-"*80)

result4 = model.calculate_funding_rate(
    mark_price=51500.0,    # åˆçº¦ä»·æ ¼ +3%
    index_price=50000.0,   # ç°è´§ä»·æ ¼
    long_short_ratio=3.0,  # å¤šç©ºæ¯”3:1ï¼ˆä¸¥é‡å¤±è¡¡ï¼‰
    open_interest=20000000,  # é«˜æŒä»“é‡ $20M
)

print(f"\næ ‡è®°ä»·æ ¼: $51,500 (+3.0%)")
print(f"æŒ‡æ•°ä»·æ ¼: $50,000")
print(f"æº¢ä»·æŒ‡æ•°: {result4.premium_index:.4%}")
print(f"å¤šç©ºæ¯”: 3.0:1 (ä¸¥é‡å¤±è¡¡)")
print(f"æŒä»“é‡: $20,000,000")
print(f"\nâœ… èµ„é‡‘è´¹ç‡: {result4.funding_rate:.4%} (8å°æ—¶)")
print(f"   å¹´åŒ–è´¹ç‡: {result4.annualized_rate:.2%}")
print(f"   å¸‚åœºæƒ…ç»ª: {result4.market_sentiment.value}")
print(f"\næŒä»“æˆæœ¬ï¼ˆ$10,000ä»“ä½/8å°æ—¶ï¼‰:")
print(f"   å¤šå¤´: ${result4.long_cost_8h:+.2f} ğŸ’¸ğŸ’¸ (æé«˜æˆæœ¬)")
print(f"   ç©ºå¤´: ${result4.short_cost_8h:+.2f} ğŸ’°ğŸ’° (ä¸°åšæ”¶ç›Š)")

daily_long_cost_extreme = model.estimate_daily_cost(10000, "long", result4.funding_rate)
print(f"\nğŸ“Š å¤šå¤´æ¯æ—¥æˆæœ¬: ${daily_long_cost_extreme:+.2f}")
print(f"   âš ï¸  æŒä»“30å¤©æˆæœ¬: ${daily_long_cost_extreme * 30:+.2f}")


# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# åœºæ™¯5ï¼šèµ„é‡‘è´¹ç‡å‹åŠ›åˆ†æ
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
print("\n[åœºæ™¯5] èµ„é‡‘è´¹ç‡ä½œä¸ºå¸‚åœºå‹åŠ›æŒ‡æ ‡")
print("-"*80)

scenarios = [
    ("ä¸­æ€§å¸‚åœº", result1),
    ("åå¤šå¸‚åœº", result2),
    ("åç©ºå¸‚åœº", result3),
    ("æç«¯å¸‚åœº", result4),
]

print("\nå¸‚åœºå‹åŠ›åˆ†æ:")
for name, result in scenarios:
    pressure = model.get_funding_pressure(result.funding_rate)
    print(f"  {name:12s}: è´¹ç‡{result.funding_rate:+.4%} â†’ å‹åŠ›{pressure:.2f}")


# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# æ€»ç»“
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
print("\n" + "="*80)
print("âœ… èµ„é‡‘è´¹ç‡æ¨¡å‹æµ‹è¯•å®Œæˆ")
print("="*80)

print("\nğŸ“Š å…³é”®å‘ç°:")
print(f"  1. ä¸­æ€§å¸‚åœºè´¹ç‡: {result1.funding_rate:.4%} â‰ˆ 0")
print(f"  2. åå¤šå¸‚åœºè´¹ç‡: {result2.funding_rate:+.4%} (å¤šå¤´æ”¯ä»˜)")
print(f"  3. åç©ºå¸‚åœºè´¹ç‡: {result3.funding_rate:+.4%} (ç©ºå¤´æ”¯ä»˜)")
print(f"  4. æç«¯å¸‚åœºè´¹ç‡: {result4.funding_rate:+.4%} (æé«˜æˆæœ¬)")

print("\nğŸ¯ æ ¸å¿ƒæˆå°±:")
print("  ã€èµ„é‡‘è´¹ç‡æ¨¡æ‹Ÿã€‘âœ¨ å·²å®Œæˆï¼")
print("  - åŸºäºæº¢ä»·æŒ‡æ•°è®¡ç®—è´¹ç‡")
print("  - è€ƒè™‘å¤šç©ºæ¯”å’ŒæŒä»“é‡")
print("  - è®¡ç®—æŒä»“æˆæœ¬")
print("  - åˆ¤æ–­å¸‚åœºæƒ…ç»ª")
print("  - è½¬æ¢ä¸ºå¸‚åœºå‹åŠ›æŒ‡æ ‡")

print("\nğŸ’¡ å®é™…å½±å“:")
print("  â†’ Agentéœ€è¦è€ƒè™‘èµ„é‡‘è´¹ç‡æˆæœ¬")
print("  â†’ é«˜è´¹ç‡æ—¶é¿å…æŒæœ‰è¯¥æ–¹å‘ä»“ä½")
print("  â†’ æç«¯è´¹ç‡å¯èƒ½è§¦å‘ç­–ç•¥åˆ‡æ¢")

print("\n" + "="*80)

