# Prometheus v5.2 开发计划
## 副标题：引入可控的混乱

**开始日期**: 2025-12-05  
**预计完成**: 2025-12-12（1周）  
**当前版本**: v5.1.3  
**目标版本**: v5.2 (Controlled Chaos)

---

## 🎯 核心理念

### 从温室到荒野的第一步

**v5.1.3问题**：
- 过度保护（强制繁殖100%保证）
- 过度确定性（变异率固定）
- 过度简化（市场模型太干净）
- 过度安全（测试100%通过）

**v5.2目标**：
- 引入10-20%的不确定性
- 允许小幅失败
- 增加真实市场噪声
- 保持70-80%稳定性

**哲学转变**：
```
从 "永不失败的优化器"
到 "允许小规模失败的演化系统"
```

---

## 🔧 5大核心改进

### 改进1：允许种群波动 (5%萎缩)

**当前代码** (`evolution_manager_v5.py`):
```python
# 强制保证：繁殖数 = 淘汰数
while len(new_agents) < eliminate_count:
    # 强制繁殖直到补满
```

**v5.2改进**:
```python
# 允许5%的缺口
target_count = int(eliminate_count * 0.95)  # 95%目标
while len(new_agents) < target_count:
    # 只要达到95%即可
    
# 如果低于90%，才触发强制繁殖
if len(new_agents) < eliminate_count * 0.90:
    logger.warning("种群萎缩超过10%，触发强制繁殖")
    # 强制繁殖
```

**效果**：
- 允许种群从50波动到47-48
- 极端情况下可能降到45
- 但不会崩溃

**风险**：低

---

### 改进2：变异率随机化 (±20%噪声)

**当前代码** (`evolution_manager_v5.py`):
```python
mutation_rate = self._calculate_dynamic_mutation_rate(gene_entropy)
# 确定性：基因熵0.1 → 变异率26.7%
```

**v5.2改进**:
```python
base_rate = self._calculate_dynamic_mutation_rate(gene_entropy)
# 加入随机噪声
noise_factor = random.uniform(0.8, 1.2)  # ±20%
mutation_rate = base_rate * noise_factor

logger.debug(f"变异率: {base_rate:.1%} × {noise_factor:.2f} = {mutation_rate:.1%}")
```

**效果**：
- 基础10% → 实际8-12%
- 危机60% → 实际48-72%
- 不可完全预测

**风险**：低

---

### 改进3：市场噪声层 (新增模块)

**创建新文件**: `prometheus/core/market_noise.py`

```python
class MarketNoiseLayer:
    """
    真实市场的噪声与突变
    
    包括：
    1. 流动性突变 (±50%)
    2. 滑点尖峰 (×2-5)
    3. 资金费率跳跃 (±0.3%)
    4. 订单簿断层 (随机)
    5. 成交延迟 (随机)
    """
    
    def __init__(self,
                 liquidity_shock_prob=0.05,     # 5%概率
                 slippage_spike_prob=0.10,      # 10%概率
                 funding_jump_prob=0.03,         # 3%概率
                 orderbook_gap_prob=0.08):      # 8%概率
        pass
    
    def apply_noise(self, 
                   base_liquidity: float,
                   base_slippage: float,
                   base_funding: float) -> dict:
        """对市场参数应用噪声"""
        
        result = {
            'liquidity': base_liquidity,
            'slippage': base_slippage,
            'funding': base_funding,
            'events': []
        }
        
        # 1. 流动性突变
        if random.random() < self.liquidity_shock_prob:
            shock = random.uniform(-0.5, -0.2)  # 降低20-50%
            result['liquidity'] *= (1 + shock)
            result['events'].append(f'流动性冲击{shock:.1%}')
        
        # 2. 滑点尖峰
        if random.random() < self.slippage_spike_prob:
            spike = random.uniform(2.0, 5.0)  # 2-5倍
            result['slippage'] *= spike
            result['events'].append(f'滑点尖峰×{spike:.1f}')
        
        # 3. 资金费率跳跃
        if random.random() < self.funding_jump_prob:
            jump = random.uniform(-0.003, 0.003)  # ±0.3%
            result['funding'] += jump
            result['events'].append(f'资金费率跳跃{jump:+.2%}')
        
        # 4. 订单簿断层
        if random.random() < self.orderbook_gap_prob:
            gap_penalty = random.uniform(1.5, 3.0)
            result['slippage'] *= gap_penalty
            result['events'].append(f'订单簿断层×{gap_penalty:.1f}')
        
        return result
```

**集成位置**: `test_extreme_stress.py`

```python
from prometheus.core.market_noise import MarketNoiseLayer

# 创建噪声层
noise_layer = MarketNoiseLayer()

# 每轮应用噪声
for cycle in range(cycles):
    # 应用噪声
    noisy_conditions = noise_layer.apply_noise(
        base_liquidity=1.0,
        base_slippage=0.005,
        base_funding=0.01
    )
    
    # 使用噪声后的条件
    market_condition = MarketCondition(
        liquidity_multiplier=noisy_conditions['liquidity'],
        ...
    )
```

**效果**：
- 每轮5-10%概率出现市场异常
- Agent体验真实市场波动
- 增加环境复杂度

**风险**：中

---

### 改进4：允许策略死亡

**当前代码** (`niche_protection.py`):
```python
# 所有策略都保护
if population_ratio < self.min_diversity_ratio:
    bonus = self.PROTECTION_FACTOR * (...)
    # 给予奖励
```

**v5.2改进**:
```python
# 只保护中等适应度以上的策略
MIN_FITNESS_THRESHOLD = 0.3  # 适应度>30%才保护

def adjust_agent_score(self, agent, population_ratio):
    # 如果适应度太低，不保护
    if agent.fitness < self.MIN_FITNESS_THRESHOLD:
        # 允许自然淘汰
        return 0.0
    
    # 中等以上才保护
    if population_ratio < self.min_diversity_ratio:
        bonus = self.PROTECTION_FACTOR * (...)
        return bonus
```

**效果**：
- 真正的弱者会被淘汰
- 不是所有少数派都保护
- 自然选择开始生效

**风险**：中

---

### 改进5：降低保护触发频率

**当前代码** (`evolution_manager_v5.py`):
```python
# 每轮都检查
diversity_crisis = health.gene_entropy <= 0.1
if diversity_crisis:
    # 立即启动保护
```

**v5.2改进**:
```python
# 连续N轮才触发
self.crisis_counter = 0  # 初始化

# 检查
if health.gene_entropy <= 0.1:
    self.crisis_counter += 1
else:
    self.crisis_counter = 0

# 连续3轮才触发
diversity_crisis = self.crisis_counter >= 3

if diversity_crisis:
    logger.error(f"连续{self.crisis_counter}轮基因熵<0.1，启动保护")
```

**效果**：
- 偶尔的低熵不触发
- 持续的低熵才保护
- 减少干预频率

**风险**：中

---

## 📊 预期效果对比

| 指标 | v5.1.3 | v5.2预期 | 变化 |
|------|--------|---------|------|
| 种群稳定性 | 100% | 90-95% | -5~10% |
| 基因熵(第10轮) | 0.099 | 0.08-0.12 | 波动增大 |
| 测试通过率 | 100% | 85-90% | -10~15% |
| 策略死亡事件 | 0次 | 1-3次 | 开始出现 |
| 市场异常事件 | 0次 | 5-10次 | 新增 |
| 环境复杂度 | 固定 | ×1.5 | 提升50% |

---

## 🎯 开发阶段

### 阶段1：核心机制修改（2天）

#### Day 1: 放松保护机制
- [ ] 修改 `evolution_manager_v5.py`
  - [ ] 允许5%种群波动
  - [ ] 变异率随机化
  - [ ] 降低保护触发频率
- [ ] 修改 `niche_protection.py`
  - [ ] 添加适应度阈值
  - [ ] 允许弱者死亡

#### Day 2: 实现市场噪声层
- [ ] 创建 `market_noise.py`
- [ ] 实现4种噪声类型
- [ ] 编写单元测试

### 阶段2：集成与测试（2天）

#### Day 3: 集成噪声层
- [ ] 修改 `test_extreme_stress.py`
- [ ] 集成MarketNoiseLayer
- [ ] 修改测试参数

#### Day 4: 运行测试
- [ ] 批量测试（3次）
- [ ] 收集数据
- [ ] 对比v5.1.3

### 阶段3：调优与文档（3天）

#### Day 5-6: 参数调优
- [ ] 调整噪声概率
- [ ] 调整波动范围
- [ ] 平衡稳定性

#### Day 7: 文档与发布
- [ ] 更新CHANGELOG
- [ ] 编写v5.2总结
- [ ] Git提交

---

## 🧪 测试策略

### 测试1：单机制测试

**目的**：验证每个机制单独工作

```python
# 测试1: 种群波动
test_population_fluctuation.py
- 关闭其他机制
- 只允许种群波动
- 观察波动范围

# 测试2: 变异率噪声
test_mutation_noise.py
- 记录变异率分布
- 验证±20%范围

# 测试3: 市场噪声
test_market_noise.py
- 验证各类事件触发
- 统计频率

# 测试4: 策略死亡
test_strategy_death.py
- 验证弱者淘汰
- 记录死亡事件
```

### 测试2：组合测试

**目的**：验证所有机制协同工作

```python
test_extreme_stress_v5.2.py
- 10轮进化
- 50个Agent
- 开启所有机制
- 3次独立运行
```

### 测试3：对比测试

**目的**：对比v5.1.3和v5.2

```python
compare_v5.1.3_vs_v5.2.py
- 相同初始条件
- 相同随机种子
- 对比关键指标
```

---

## 📈 成功标准

### 最低标准（必须达到）
- ✅ 系统不崩溃（种群>30）
- ✅ 偶尔出现策略死亡（1-3次）
- ✅ 市场异常事件触发（5-10次）
- ✅ 基因熵波动增大（±0.03以上）

### 理想标准（争取达到）
- ⭐ 种群稳定在45-50
- ⭐ 策略死亡后有新策略崛起
- ⭐ 环境复杂度提升显著
- ⭐ 出现新的策略模式

### 危险信号（需要回退）
- ❌ 种群崩溃（<30）
- ❌ 系统完全失控
- ❌ 基因熵<0.05
- ❌ 测试通过率<70%

---

## 🎯 实施顺序

### 第1步：最安全的改进（今天开始）

**改进1 + 改进2**：种群波动 + 变异率噪声
- 风险最低
- 影响可控
- 容易回退

### 第2步：中等风险（明天）

**改进3**：市场噪声层
- 独立模块
- 可开关
- 风险中等

### 第3步：较高风险（后天）

**改进4 + 改进5**：策略死亡 + 降低保护
- 风险较高
- 需要观察
- 可能需要调整

---

## 💡 风险管理

### 回退策略

每个改进都保留开关：

```python
class EvolutionManagerV5_2:
    def __init__(self):
        # v5.2特性开关
        self.enable_population_fluctuation = True
        self.enable_mutation_noise = True
        self.enable_market_noise = True
        self.enable_strategy_death = True
        self.enable_delayed_protection = True
```

如果出问题，可以：
1. 关闭单个特性
2. 回退到v5.1.3
3. 调整参数

### 监控指标

实时监控：
- 种群数量
- 基因熵
- 策略分布
- 异常事件频率
- 崩溃信号

---

## 📁 需要修改的文件

### 核心代码
1. `prometheus/core/evolution_manager_v5.py` - 放松保护机制
2. `prometheus/core/niche_protection.py` - 允许策略死亡
3. `prometheus/core/market_noise.py` - 新增噪声层

### 测试代码
1. `test_extreme_stress.py` - 集成噪声层
2. `test_extreme_stress_batch.py` - 批量测试
3. `test_market_noise.py` - 新增噪声测试
4. `compare_versions.py` - 新增版本对比

### 文档
1. `CHANGELOG_V5.2.md` - 版本日志
2. `V5.2_SUMMARY.md` - 版本总结
3. `PROJECT_STATUS_V5.1.md` - 更新状态

---

## 🎊 里程碑

- [ ] Day 1: 核心机制修改完成
- [ ] Day 2: 市场噪声层完成
- [ ] Day 3: 集成完成
- [ ] Day 4: 测试完成
- [ ] Day 5-6: 调优完成
- [ ] Day 7: v5.2发布

---

## 🎯 最终愿景

v5.2是从"温室"到"荒野"的**第一步**。

它不完美，但它：
- 开始引入不确定性
- 开始允许失败
- 开始模拟真实
- 开始向CAS演化

**下一步**：v5.3（开放世界）  
**最终目标**：v6.0（真实CAS）

---

**创建日期**: 2025-12-05  
**预计开始**: 2025-12-05 下午  
**预计完成**: 2025-12-12  

**开发者**: Prometheus团队  
**版本**: v5.2 开发计划 1.0

---

*"第一步总是最难的，但只要迈出去，就已经在路上了。"*

