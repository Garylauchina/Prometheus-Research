# 🚀 实盘交易系统使用指南

**创建时间**: 2025-12-06  
**系统版本**: 完整版（真实下单）  
**重要性**: ⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐

---

## 📋 目录

1. [系统说明](#系统说明)
2. [部署步骤](#部署步骤)
3. [监控和管理](#监控和管理)
4. [风险提示](#风险提示)
5. [常见问题](#常见问题)

---

## 📖 系统说明

### 新系统 vs 旧系统

```
旧系统（live_engine_fixed.py）：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 获取实时价格
✅ Agent做决策
❌ 不真实下单（TODO注释）
❌ 模拟盈亏

新系统（live_engine_full.py）：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 获取实时价格
✅ Agent做决策
✅ 真实下单到OKX ← 新增
✅ 持仓跟踪 ← 新增
✅ 真实盈亏计算 ← 新增
✅ 止盈止损 ← 新增
✅ 异常处理 ← 新增
```

### 核心功能

1. **真实下单**
   - 支持开多（buy）
   - 支持开空（sell）
   - 支持平仓（close）
   - 市价单执行

2. **持仓跟踪**
   - 记录每个Agent的持仓
   - 实时更新盈亏
   - 自动止盈止损

3. **风控机制**
   - 止盈：盈利>5%
   - 止损：亏损>3%
   - 最大持仓限制
   - 最大杠杆限制

4. **双模式**
   ```python
   enable_real_trading = True   # 真实交易（会在OKX下单）
   enable_real_trading = False  # 模拟模式（不会下单，仅记录）
   ```

---

## 🚀 部署步骤

### 方案A：一键部署（推荐）

```bash
# 1. 确保你在项目根目录
cd /Users/liugang/Cursor_Store/Prometheus-Quant

# 2. 运行部署脚本
bash deploy_full_to_vps.sh
```

**脚本会自动**：
- ✅ 停止旧进程
- ✅ 备份原文件
- ✅ 上传新文件
- ✅ 清空日志
- ✅ 重启系统
- ✅ 检查状态

### 方案B：手动部署

```bash
# 1. 停止VPS进程
ssh root@45.76.97.37 "pkill -f vps_main.py"

# 2. 上传文件
scp prometheus/trading/live_engine_full.py \
    root@45.76.97.37:/root/prometheus/prometheus/trading/live_engine.py

# 3. 重启
ssh root@45.76.97.37 \
    "cd /root/prometheus && nohup python3 vps_main.py --config config/vps_config.json > /dev/null 2>&1 &"
```

---

## 👀 监控和管理

### 实时查看日志

```bash
# 方法1：SSH查看
ssh root@45.76.97.37 "tail -f /root/prometheus/prometheus_vps.log"

# 方法2：使用Python脚本
python3 view_vps_log.py
```

### 关键日志标识

```
✅ 成功下单:
2025-12-06 20:00:00 [INFO] ... ✅ 订单成功: 123456789

✅ 平仓成功:
2025-12-06 20:01:00 [INFO] ... ✅ 平仓成功 (PnL: +2.5%)

❌ 下单失败:
2025-12-06 20:02:00 [ERROR] ... ❌ 下单异常: ...

📊 决策统计:
2025-12-06 20:03:00 [INFO] ... 📊 决策统计: 3开多 / 2开空 / 1平仓 / 44持有
```

### 停止系统

```bash
# 停止VPS进程
ssh root@45.76.97.37 "pkill -f vps_main.py"
```

### 检查进程

```bash
# 查看是否在运行
ssh root@45.76.97.37 "ps aux | grep vps_main.py | grep -v grep"
```

---

## ⚠️  风险提示

### 🔴 重要警告

```
当前系统默认配置：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
enable_real_trading = True  ← 会真实下单！
paper_trading = true        ← 但连接的是模拟盘

结果：
✅ 会在OKX模拟盘下单（可以在页面看到）
❌ 不会影响真实资金
```

### 模拟盘 vs 实盘

| 配置 | 模拟盘 | 实盘 |
|------|--------|------|
| OKX配置 | `paper_trading: true` | `paper_trading: false` |
| API密钥 | 模拟盘密钥 | 实盘密钥 |
| 资金 | 虚拟（默认10万U） | 真实资金 |
| 订单 | 在模拟盘页面显示 | 在实盘页面显示 |
| 风险 | ✅ 无风险 | ⚠️ 有风险 |

### 检查清单

```
部署前必须检查：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
□ VPS配置文件中 paper_trading = true
□ API密钥是模拟盘密钥
□ 登录OKX模拟盘页面确认
□ 初始资金合理（建议不超过总资金的10%）
□ 最大持仓合理
□ 最大杠杆合理

如果要切换到实盘：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
1. ⚠️  再三确认策略已充分验证
2. 修改 paper_trading = false
3. 使用实盘API密钥
4. 从小资金开始（1%总资金）
5. 密切监控至少1周
```

---

## 🐛 常见问题

### Q1: 在OKX页面看不到订单

**可能原因**：
1. 系统还在模拟模式（enable_real_trading=False）
2. 还没有触发交易条件（价格变化太小）
3. size太小被过滤了
4. API连接有问题

**解决方案**：
```bash
# 1. 查看日志确认是否有下单记录
ssh root@45.76.97.37 "grep '订单成功' /root/prometheus/prometheus_vps.log"

# 2. 查看是否有错误
ssh root@45.76.97.37 "grep '❌' /root/prometheus/prometheus_vps.log | tail -20"

# 3. 确认配置
ssh root@45.76.97.37 "cat /root/prometheus/config/vps_config.json"
```

### Q2: 频繁触发止损

**原因**：
- 止损阈值太小（3%）
- 杠杆太高
- 市场波动太大

**解决方案**：
```python
# 修改 live_engine_full.py 中的止损阈值
if pnl_ratio < -0.05:  # 改为5%
    return {'action': 'close', 'reason': '止损'}
```

### Q3: 没有触发交易

**原因**：
- 价格变化太小（<0.01%）
- size计算太小（<0.0001）

**解决方案**：
```python
# 进一步降低阈值
if abs(price_change) < 0.00005:  # 改为0.005%
```

### Q4: API报错 "APIKey does not match"

**原因**：
- 模拟盘密钥用于实盘（或反之）

**解决方案**：
1. 确认 paper_trading 配置
2. 确认API密钥来源（模拟盘 vs 实盘）
3. 重新生成正确的API密钥

---

## 📊 监控指标

### 关键指标

```
每个交易周期应显示：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 当前价格: $89,500.00
📈 价格变化: +0.05%
👥 活跃Agent: 50
📊 决策统计: 3开多 / 2开空 / 1平仓 / 44持有
💰 账户总价值: $102,345.00
👥 存活Agent: 50/50
📊 平均资金: $10,234.50
📈 当前持仓: 6个
```

### 健康标准

```
✅ 正常:
- 每周期都有日志
- 决策统计正常
- 持仓数量合理（<总Agent数的20%）
- 没有频繁止损

⚠️  需要注意:
- 持仓数量过多（>总Agent数的50%）
- 频繁止损（>10次/小时）
- API错误频繁

❌ 需要停止:
- 连续亏损超过20%
- API连接失败
- 系统异常频繁
```

---

## 🎯 最佳实践

### 第一次运行

```
建议步骤：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
1. enable_real_trading = False (先模拟)
2. 运行1小时观察决策逻辑
3. enable_real_trading = True (启用真实)
4. 在模拟盘运行24小时
5. 验证策略有效性
6. (可选) 切换到实盘小资金测试
```

### 日常监控

```
每天检查：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
□ 系统是否运行中
□ 是否有错误日志
□ 账户总价值变化
□ 存活Agent数量
□ 持仓情况

每周检查：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
□ 总体盈亏
□ 胜率统计
□ 平均盈亏比
□ 最大回撤
```

---

## 📞 紧急情况

### 立即停止系统

```bash
# 方法1: 停止进程
ssh root@45.76.97.37 "pkill -f vps_main.py"

# 方法2: 平掉所有持仓（如果有API访问）
# 手动在OKX页面操作

# 方法3: 修改配置禁用交易
ssh root@45.76.97.37 "echo 'emergency_stop: true' >> /root/prometheus/config/vps_config.json"
```

---

## 📝 总结

```
完整版实盘系统已准备就绪：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 真实下单功能
✅ 持仓跟踪系统
✅ 盈亏计算
✅ 止盈止损
✅ 异常处理
✅ 详细日志

当前配置（安全）：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 连接模拟盘（paper_trading=true）
✅ 真实下单启用（enable_real_trading=True）
✅ 可在OKX模拟盘页面看到订单
✅ 不影响真实资金

下一步：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
1. bash deploy_full_to_vps.sh
2. 观察日志
3. 验证策略
4. 不忘初心：盈利！💰
```

---

**创建时间**: 2025-12-06  
**文档版本**: v1.0  
**系统状态**: ✅ 生产就绪

> "在黑暗中寻找亮光，在混沌中寻找规则，  
> 在死亡中寻找生命，不忘初心，方得始终。"

