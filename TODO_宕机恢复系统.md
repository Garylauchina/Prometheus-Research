# 宕机恢复系统 - 明天TODO

## 📅 **2025-12-03（明天）**

---

## ✅ **Phase 1: 基础持久化**

### **1.1 创建核心类**
- [ ] 创建 `prometheus/core/persistence.py`
- [ ] 实现 `PersistenceManager` 类
- [ ] 实现 `RecoverySystem` 类
- [ ] 实现 `ReconciliationReport` 类

### **1.2 数据结构设计**
- [ ] 定义Agent状态JSON schema
- [ ] 定义账簿JSON schema
- [ ] 定义检查点JSON schema

### **1.3 自动保存机制**
- [ ] 在Supervisor.run()中添加定期保存（每5个周期）
- [ ] 在交易执行后添加保存触发
- [ ] 添加Ctrl+C信号捕获（优雅退出）
- [ ] 测试保存功能

---

## ✅ **Phase 2: 三方对账（核心）**

### **2.1 对账逻辑**
- [ ] 实现 `reconcile_positions()` 方法
- [ ] 获取OKX实际持仓
- [ ] 比对公共账簿、私有账簿、OKX持仓
- [ ] 生成对账报告

### **2.2 不一致检测**
- [ ] 检测持仓数量不一致
- [ ] 检测持仓方向不一致
- [ ] 检测资金余额不一致
- [ ] 检测订单缺失

### **2.3 自动纠正**
- [ ] 实现"OKX持仓>账簿"的纠正（补全订单）
- [ ] 实现"账簿>OKX持仓"的纠正（标记已平仓）
- [ ] 实现"公共≠私有"的纠正（同步）
- [ ] 实现"持仓方向不一致"的警告（人工介入）
- [ ] 测试各种不一致场景

---

## ✅ **Phase 3: 完整恢复**

### **3.1 Agent状态恢复**
- [ ] 保存Agent完整状态（基因、性格、情绪等）
- [ ] 恢复Agent所有属性
- [ ] 恢复Agent交易权限和奖章
- [ ] 测试Agent恢复

### **3.2 系统组件恢复**
- [ ] 恢复英灵殿（Valhalla）
- [ ] 恢复Supervisor状态（环境压力、排名等）
- [ ] 恢复Mastermind状态（战略历史）
- [ ] 恢复公告板历史（可选）

### **3.3 恢复流程集成**
- [ ] 在启动器中添加恢复检测
- [ ] 显示恢复报告
- [ ] 询问用户是否继续
- [ ] 测试完整恢复流程

---

## ✅ **Phase 4: 测试与优化**

### **4.1 场景测试**
- [ ] 测试正常退出恢复
- [ ] 测试异常崩溃恢复（模拟kill -9）
- [ ] 测试数据不一致恢复
- [ ] 测试快照过期恢复

### **4.2 边界测试**
- [ ] 测试无恢复数据（首次启动）
- [ ] 测试Agent全部死亡恢复
- [ ] 测试大量Agent恢复（100个）
- [ ] 测试快照损坏恢复（使用备份）

### **4.3 性能优化**
- [ ] 优化保存速度（<100ms）
- [ ] 优化恢复速度（<30秒）
- [ ] 实现增量保存
- [ ] 实现快照压缩

---

## 📁 **需要创建的文件**

```
prometheus/core/
└── persistence.py          # 持久化管理器

prometheus/core/
└── recovery.py             # 恢复系统

persistence/                # 数据存储目录
├── snapshots/              # 完整快照
├── incremental/            # 增量保存
│   ├── checkpoint_latest.json
│   ├── public_ledger.json
│   ├── private_ledgers/
│   ├── agents/
│   ├── valhalla.json
│   ├── supervisor_state.json
│   └── mastermind_state.json
└── recovery_log.txt

tests/
└── test_recovery.py        # 恢复系统测试
```

---

## 🔧 **需要修改的文件**

```
examples/v4_okx_simplified_launcher.py
- 添加恢复检测
- 集成RecoverySystem

prometheus/core/supervisor.py
- 添加自动保存触发
- 添加信号捕获（Ctrl+C）

prometheus/core/agent_v4.py
- 添加to_dict()方法（序列化）
- 添加from_dict()方法（反序列化）

prometheus/core/ledger_system.py
- 添加save()方法
- 添加load()方法
```

---

## 🎯 **优先级排序**

### **P0 - 必须完成**
1. ✅ Agent状态保存/恢复（基因、性格、资金）
2. ✅ 账簿保存/恢复（公共+私有）
3. ✅ 三方对账逻辑
4. ✅ 基本纠正策略（同步到OKX）

### **P1 - 重要**
5. ✅ 英灵殿恢复
6. ✅ Supervisor状态恢复
7. ✅ 自动保存机制
8. ✅ 恢复报告生成

### **P2 - 可选**
9. ⏳ Agent情绪状态恢复
10. ⏳ 多版本快照备份
11. ⏳ 增量保存优化
12. ⏳ 性能优化

---

## 🚨 **注意事项**

1. **数据安全第一**: 使用临时文件+重命名保存，防止中途崩溃
2. **三方对账是核心**: 这是最复杂也最重要的部分
3. **以OKX为准**: 对账不一致时，优先信任OKX实际持仓
4. **充分测试**: 各种崩溃场景都要测试
5. **用户友好**: 恢复报告要清晰易懂

---

## ⏱️ **预计时间**

- Phase 1: 2-3小时
- Phase 2: 3-4小时 ⭐ (最难)
- Phase 3: 2-3小时
- Phase 4: 2-3小时

**总计: 9-13小时**（建议分两天完成）

---

## 📖 **参考文档**

- `宕机恢复系统_设计规划.md` - 完整设计方案
- `双账簿系统_完整设计.md` - 账簿系统参考
- `完整架构重构_最终版.md` - 架构参考

---

**🎯 准备好开始了！明天加油！**

